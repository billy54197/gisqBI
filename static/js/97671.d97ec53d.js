"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[97671],{79969:function(w,I,s){s.d(I,{X:function(){return S}});var P=s(935051),v=s(470709),R=s(155946),O=s(365148);let y=R.Z.state.view.viewType,g="/thirdparty/databrain",S={remoteproject(){return y==O.Z.editType.public.code?(0,v.xV)(g+"/remoteproject"):(0,P.getRequest)(g+"/remoteproject")},remotemodels(_){return y==O.Z.editType.public.code?(0,v.xV)(g+"/remotemodels/"+_):(0,P.getRequest)(g+"/remotemodels/"+_)},model(_){return y==O.Z.editType.public.code?(0,v.M0)(g+"/model/",_):(0,P.postRequest)(g+"/model/",_)}}},397671:function(w,I,s){s.r(I),s.d(I,{default:function(){return m}});var P=function(){var t=this,e=t._self._c;return e("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"controlData",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"}},[e("hide-button",{attrs:{attr:t.widgetInfo.attr}}),e("el-popover",{attrs:{"popper-class":"controlData",trigger:t.widgetInfo.config.attributes.trigger,placement:t.widgetInfo.config.attributes.placement,"visible-arrow":t.widgetInfo.config.button.arrow,offset:t.widgetInfo.config.attributes.offset,transition:"el-fade-in",title:t.widgetInfo.config.attributes.title},model:{value:t.visible,callback:function(r){t.visible=r},expression:"visible"}},[e("div",{staticStyle:{width:"350px","min-height":"80px",padding:"5px"}},[e("el-form",{attrs:{"label-width":"90px"}},[e("el-form-item",{attrs:{label:"\u9009\u62E9\u6A21\u578B\uFF1A"}},[e("el-select",{staticStyle:{width:"90%"},attrs:{placeholder:"\u6A21\u578B\u5217\u8868",size:"small","popper-append-to-body":!1},on:{change:t.modelChange},model:{value:t.widgetInfo.config.modelId,callback:function(r){t.$set(t.widgetInfo.config,"modelId",r)},expression:"widgetInfo.config.modelId"}},t._l(t.modelList,function(r,c){return e("el-option",{key:c,attrs:{label:r.title,value:r.id}})}),1)],1),t.model?e("div",[e("div",{staticStyle:{padding:"5px 0"}},[e("div",{staticClass:"title"},[t._v(t._s(t.model.title))]),e("span",{staticClass:"description"},[t._v("\u6A21\u578B\u7684\u63CF\u8FF0\uFF1A"+t._s(t.model.desc))])]),e("el-card",{staticClass:"box-card"},[e("div",{staticClass:"process"},t._l(t.model.nodeList,function(r,c){return e("div",{key:c+"model"},[e("div",[e("el-row",[e("el-col",{attrs:{span:12}},[e("el-button",{staticStyle:{width:"100%",padding:"12px 0","pointer-events":"none"},attrs:{plain:""}},[t._v(" "+t._s(r.title+"("+r.alias+")")+" ")])],1),e("el-col",{attrs:{span:12}},[e("div",{staticClass:"description"},[t._v(t._s(r.desc))])])],1),t.model.nodeList[t.model.nodeList.length-1]!==r?e("p",{staticStyle:{width:"160px","text-align":"center"}},[e("i",{staticClass:"el-icon-bottom"})]):t._e()],1)])}),0),e("div",{class:Number(t.model.status)===2?"success":"error"},[t._v(" "+t._s(this.setStatus(t.model.status))+" ")])]),t.model.refParamList[0].type===1?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u8BF7\u5728\u5730\u56FE\u4E0A\u9009\u53D6\u9700\u8981\u5206\u6790\u7684\u8303\u56F4\uFF1A","label-width":"240px"}},[e("el-button",{staticStyle:{padding:"8px 20px"},attrs:{size:"mini",type:"primary"},on:{click:t.selectRange}},[t._v("\u9009\u53D6\u8303\u56F4 ")])],1):t._e(),t.model.refParamList[0].type===1?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u56FE\u5C42\u5730\u5740\uFF1A","label-width":"100px"}},[e("el-input",{model:{value:t.layerURL,callback:function(r){t.layerURL=r},expression:"layerURL"}}),e("el-button",{staticStyle:{padding:"8px 20px"},attrs:{size:"mini",type:"primary"},on:{click:t.addLayer}},[t._v("\u6DFB\u52A0\u56FE\u5C42 ")])],1):t._e(),t.model.refParamList[0].type===0?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u8F93\u5165\u5B57\u7B26\u4E32\uFF1A","label-width":"100px"}},[e("el-input",{attrs:{size:"mini",placeholder:"\u8BF7\u8F93\u5165\u8981\u5206\u6790\u7684\u8303\u56F4"},on:{change:t.stringChange},model:{value:t.paramString,callback:function(r){t.paramString=r},expression:"paramString"}})],1):t._e(),e("el-form-item",{staticStyle:{"text-align":"center",margin:"0"},attrs:{"label-width":"0"}},[e("el-button",{staticStyle:{padding:"8px 30px"},attrs:{size:"mini",type:"primary"},on:{click:t.submit}},[t._v("\u83B7\u53D6\u5206\u6790\u7ED3\u679C ")])],1)],1):t._e()],1)],1),e("el-button",{style:t.btnStyle,attrs:{slot:"reference"},slot:"reference"})],1),e("el-dialog",{directives:[{name:"dialogDrag",rawName:"v-dialogDrag"}],attrs:{title:"\u5F53\u524D\u56FE\u5C42\u5206\u6790\u7ED3\u679C",visible:t.dialogVisible,"append-to-body":!0,top:"20vh","close-on-click-modal":!1,width:t.bigDialog?"50%":"30%",height:"300"},on:{"update:visible":function(r){t.dialogVisible=r}}},[e("el-table",{staticClass:"data-base-table",attrs:{data:t.gridData,size:"mini",height:"300"}},t._l(t.propData,function(r,c){return e("el-table-column",{key:c,attrs:{property:r,label:r,width:t.bigDialog?"160":""}})}),1)],1)],1)},v=[],R=s(927966),O=s(445061),y=s(126711),g=s(844513),S=s(79969),_=s(386892),L=s(957922),x=s(372449),T=s(313927),D=s(181121),M=s(2487),C=s(337564),E=s(682571),p=s(568640),o=s(23230),n=s(505689),a=s(555616),l=s(149500),f={name:"control-data",props:["widgetInfo"],components:{HideButton:g.Z},mixins:[O.u,y.H,_.D],data(){return{visible:!1,setDisabled:!1,model:null,paramString:"",modelList:[],dialogVisible:!1,map:null,timer:"",pickupLayer:null,pickupSource:null,draw:null,bigDialog:!1,propData:[],gridData:[],layerURL:"http://192.168.11.77:8080/geoserver/postgis/wfs?layer=postgis:CombinSD3",btnStyle:{backgroundColor:"#409eff",borderColor:"#409eff",backgroundImage:"url("+s(947648)+")",backgroundSize:"70% 70%",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"28px",height:"28px",opacity:1}}},mounted(){this.timer=setInterval(this.getBindMap,500),this.initAction(this.widgetInfo),this.loadInfo(this.widgetInfo)},methods:{loadInfo(i){this.widgetInfo.config.projectId&&this.getProjectList(this.widgetInfo.config.projectId);let t=i.config.imgIconConfig.img;t?(this.btnStyle.backgroundImage=`url(${t})`,this.btnStyle.backgroundSize=i.config.imgIconConfig.width+"px "+i.config.imgIconConfig.height+"px"):this.btnStyle.backgroundImage="url("+s(947648)+")",this.btnStyle.width=i.attr.w+"px",this.btnStyle.height=i.attr.h+"px",this.btnStyle.opacity=i.attr.opacity,i.attr.backgroundColor?this.btnStyle.backgroundColor=i.attr.backgroundColor:this.btnStyle.backgroundColor="#409eff"},reLoadInfo(i){i&&(this.$refs.controlData.style.width=i.attr.w+"px",this.$refs.controlData.style.height=i.attr.hh+"px"),this.loadInfo(i)},getBindMap(){window.shinemap&&(clearInterval(this.timer),this.map=window.shinemap,this.map&&(l.log("\u5927\u6570\u636E\u7EC4\u4EF6\u6355\u83B7map\u5BF9\u8C61\u6210\u529F\uFF0C\u5173\u95ED\u5B9A\u65F6\u5668\u5E76\u521D\u59CB\u5316\u5927\u6570\u636E\u62FE\u53D6\u8303\u56F4\u56FE\u5C42"),this.pickupSource=new M.default({wrapX:!1}),this.pickupLayer=new x.default({source:this.pickupSource,style:new E.ZP({fill:new p.Z({color:"rgba(255, 0, 0, 0)"}),stroke:new o.Z({color:"#FF0000",width:2}),image:new n.Z({radius:7,fill:new p.Z({color:"#ffcc33"})})}),zIndex:99}),this.map.addLayer(this.pickupLayer)))},initAction(i){this.actionReceive(i)},getProjectList(i){let t=this;S.X.remotemodels(i).then(e=>{if(t.modelList=e.data,this.widgetInfo.config.modelId){let r=this.$$lib__.find(this.modelList,c=>c.id==this.widgetInfo.config.modelId);r&&(this.model=r)}l.info(this.model)}).catch(e=>{l.log(e)})},modelChange(){if(this.widgetInfo.config.modelId){let i=this.$$lib__.find(this.modelList,t=>t.id==this.widgetInfo.config.modelId);i&&(this.model=i)}},stringChange(){},selectRange(){if(this.draw){this.map.removeInteraction(this.draw),this.draw=void 0;return}this.draw=new L.ZP({source:this.pickupSource,type:"Polygon"}),this.map.addInteraction(this.draw),this.feartures=[],this.draw.on("drawend",i=>{this.feartures.push(i.feature)})},addLayer(){this.map||(this.map=window.shinemap),this.map.getLayers().getArray().forEach(h=>{h.values_.id==="sd_layer"&&this.map.removeLayer(h)});let t=this.layerURL.split("?")[0],e=this.layerURL.split("?")[1].split("=")[1],r=[117.8842226380001,27.95433125200003,122.25971163300011,30.984672605000046];this.currentWkid=this.map.getView().getProjection().getCode();let c=new T.default({source:new D.Z({url:t,params:{LAYERS:e,VERSION:"1.1.0"},projection:this.currentWkid,serverType:"geoserver"})});this.map.addLayer(c),this.map.getView().fit(r,{size:this.map.getSize()})},submit(){let i=this.getRequestData(),t=new C.default().writeFeatures(this.feartures),e=JSON.parse(t);e.features.forEach(r=>{r.properties||(r.properties={})}),t=JSON.stringify(e),this.map.removeInteraction(this.draw),i.refParamList[0].value=t,this.executeModel(i)},getRequestData(){let i={modelId:"",pageHelper:{pageIndex:0,pageSize:50},refParamList:null};return i.modelId=this.model.id,i.refParamList=JSON.parse(JSON.stringify(this.model.refParamList)),this.$$lib__.each(i.refParamList,t=>{t.value=null}),JSON.parse(JSON.stringify(i))},executeModel(i){let t=this.$loading({lock:!0,text:"\u6B63\u5728\u5206\u6790\uFF0C\u8BF7\u7A0D\u540E...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"});S.X.model(i).then(e=>{t.close(),this.sendoutResponseData(e.data),this.showMapInfo(e.data)}).then(e=>{}).catch(e=>{l.log(e)})},showMapInfo(i){let t=this.getWidgetObject(this.widgetInfo.action.gisMapId),e={type:"FeatureCollection",features:[]};this.$$lib__.each(i.data,r=>{e.features.push(JSON.parse(r))}),t.$refs.gismap.map.locateGeoJson(JSON.stringify(e))},setButtonStyle(){return{backgroundColor:"#409eff",borderColor:"#409eff",backgroundImage:"url("+s(947648)+")",backgroundSize:"70% 70%",backgroundPosition:"center",backgroundRepeat:"no-repeat"}},setStatus(i){switch(Number(i)){case 0:return this.setDisabled=!0,"*\u6A21\u578B\u672A\u542F\u52A8";case 1:return this.setDisabled=!0,"*\u6A21\u578B\u542F\u52A8\u4E2D";case 2:return this.setDisabled=!1,"*\u6A21\u578B\u8FD0\u884C\u4E2D";case 3:return this.setDisabled=!0,"*\u6A21\u578B\u5DF2\u7EC8\u6B62"}},sendoutResponseData(i){let t=this,e=this.widgetInfo;this.$$lib__.each(e.action.sendOut.actionList,r=>{if(r.enabled&&r.code==t.$$global_editor.actionType.responseData.code){let c=r.code+"_"+e.id,h=i;if(r.script&&r.script.enabled){if(l.log("Execute script for "+r.name+" component to "+r.script.title+" component"),r.script.content==""){a.Message.warning({message:"\u81EA\u5B9A\u4E49\u811A\u672C\u5DF2\u542F\u7528\uFF0C\u4F46\u672A\u7F16\u5199\u4EFB\u4F55\u811A\u672C",offset:60});return}this.customScript_actionSend_responseData=new Function("param",r.script.content),h=this.customScript_actionSend_responseData(h)}R.Z.$emit(c,h),r.postMessage&&this.doPostMessage(h),this.actionNameList.push(c)}})},actionReceive(i){if(i.action==null||i.action.receive==null)return;let t=i.action.receive.executeModel;t&&t.enabled&&t.executeList&&t.executeList.length>0&&this.$$lib__.each(t.executeList,e=>{let r=e[0][1];R.Z.$on(r,c=>{i.action.receive.executeModel.script&&i.action.receive.executeModel.script.enabled&&(l.log("Execute the script to execute model to the "+i.name+" component"),this.actionExecuteModel=new Function("info","param","action",i.action.receive.executeModel.script.content)),this.actionExecuteModel(i,c,e)})})}},actionExecuteModel(i,t,e){l.debug(e);let r=this.getRequestData();this.$$lib__.each(r.refParamList,c=>{for(let h in t)c.name==h&&(c.value=t[h])}),this.executeModel(r)},directives:{dialogDrag:{bind(i){const t=i.querySelector(".el-dialog__header"),e=i.querySelector(".el-dialog"),r=window.getComputedStyle(e,null);t.style.cursor="move",t.onmousedown=c=>{const h=c.clientX-t.offsetLeft,A=c.clientY-t.offsetTop;let j,N;r.left.includes("%")?(j=+document.body.clientWidth*(+parseFloat(r.left)/100),N=+document.body.clientHeight*(+parseFloat(r.top)/100)):(j=+parseFloat(r.left),N=+parseFloat(r.top)),document.onmousemove=function(U){const F=U.clientX-h,z=U.clientY-A;e.style.left=`${F+j}px`,e.style.top=`${z+N}px`},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null}}}}},beforeDestroy(){clearInterval(this.timer)}},d=f,u=s(768141),b=(0,u.Z)(d,P,v,!1,null,"5041cb82",null),m=b.exports},947648:function(w,I,s){w.exports=s.p+"static/img/control-data.b890af02.png"},181121:function(w,I,s){var P=s(673608),v=s(845503),R=s(610416),O=s(312059),y=s(545059),g=s(776094),S=s(985606),_=s(161625),L=s(627794),x=s(390583),T=s(577767),D=s(602692),M=function(){var E=function(p,o){return E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,a){n.__proto__=a}||function(n,a){for(var l in a)Object.prototype.hasOwnProperty.call(a,l)&&(n[l]=a[l])},E(p,o)};return function(p,o){if(typeof o!="function"&&o!==null)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");E(p,o);function n(){this.constructor=p}p.prototype=o===null?Object.create(o):(n.prototype=o.prototype,new n)}}(),C=function(E){M(p,E);function p(o){var n=this,a=o||{},l=a.imageSmoothing!==void 0?a.imageSmoothing:!0;a.interpolate!==void 0&&(l=a.interpolate);var f=a.params||{},d="TRANSPARENT"in f?f.TRANSPARENT:!0;return n=E.call(this,{attributions:a.attributions,attributionsCollapsible:a.attributionsCollapsible,cacheSize:a.cacheSize,crossOrigin:a.crossOrigin,interpolate:l,opaque:!d,projection:a.projection,reprojectionErrorThreshold:a.reprojectionErrorThreshold,tileClass:a.tileClass,tileGrid:a.tileGrid,tileLoadFunction:a.tileLoadFunction,url:a.url,urls:a.urls,wrapX:a.wrapX!==void 0?a.wrapX:!0,transition:a.transition,zDirection:a.zDirection})||this,n.gutter_=a.gutter!==void 0?a.gutter:0,n.params_=f,n.v13_=!0,n.serverType_=a.serverType,n.hidpi_=a.hidpi!==void 0?a.hidpi:!0,n.tmpExtent_=(0,g.createEmpty)(),n.updateV13_(),n.setKey(n.getKeyForParams_()),n}return p.prototype.getFeatureInfoUrl=function(o,n,a,l){var f=(0,x.get)(a),d=this.getProjection(),u=this.getTileGrid();u||(u=this.getTileGridForProjection(f));var b=u.getZForResolution(n,this.zDirection),m=u.getTileCoordForCoordAndZ(o,b);if(!(u.getResolutions().length<=m[0])){var i=u.getResolution(m[0]),t=u.getTileCoordExtent(m,this.tmpExtent_),e=(0,S.Pq)(u.getTileSize(m[0]),this.tmpSize),r=this.gutter_;r!==0&&(e=(0,S.f3)(e,r,this.tmpSize),t=(0,g.buffer)(t,i*r,t)),d&&d!==f&&(i=(0,_.aA)(d,f,o,i),t=(0,x.transformExtent)(t,f,d),o=(0,x.transform)(o,f,d));var c={SERVICE:"WMS",VERSION:v.e,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};(0,y.f0)(c,this.params_,l);var h=Math.floor((o[0]-t[0])/i),A=Math.floor((t[3]-o[1])/i);return c[this.v13_?"I":"X"]=h,c[this.v13_?"J":"Y"]=A,this.getRequestUrl_(m,e,t,1,d||f,c)}},p.prototype.getLegendUrl=function(o,n){if(this.urls[0]!==void 0){var a={SERVICE:"WMS",VERSION:v.e,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(n===void 0||n.LAYER===void 0){var l=this.params_.LAYERS,f=!Array.isArray(l)||l.length===1;if(!f)return;a.LAYER=l}if(o!==void 0){var d=this.getProjection()?this.getProjection().getMetersPerUnit():1,u=28e-5;a.SCALE=o*d/u}return(0,y.f0)(a,n),(0,R.B)(this.urls[0],a)}},p.prototype.getGutter=function(){return this.gutter_},p.prototype.getParams=function(){return this.params_},p.prototype.getRequestUrl_=function(o,n,a,l,f,d){var u=this.urls;if(u){if(d.WIDTH=n[0],d.HEIGHT=n[1],d[this.v13_?"CRS":"SRS"]=f.getCode(),"STYLES"in this.params_||(d.STYLES=""),l!=1)switch(this.serverType_){case"geoserver":var b=90*l+.5|0;"FORMAT_OPTIONS"in d?d.FORMAT_OPTIONS+=";dpi:"+b:d.FORMAT_OPTIONS="dpi:"+b;break;case"mapserver":d.MAP_RESOLUTION=90*l;break;case"carmentaserver":case"qgis":d.DPI=90*l;break;default:(0,O.h)(!1,52);break}var m=f.getAxisOrientation(),i=a;if(this.v13_&&m.substr(0,2)=="ne"){var t=void 0;t=a[0],i[0]=a[1],i[1]=t,t=a[2],i[2]=a[3],i[3]=t}d.BBOX=i.join(",");var e;if(u.length==1)e=u[0];else{var r=(0,T.$W)((0,D.vp)(o),u.length);e=u[r]}return(0,R.B)(e,d)}},p.prototype.getTilePixelRatio=function(o){return!this.hidpi_||this.serverType_===void 0?1:o},p.prototype.getKeyForParams_=function(){var o=0,n=[];for(var a in this.params_)n[o++]=a+"-"+this.params_[a];return n.join("/")},p.prototype.updateParams=function(o){(0,y.f0)(this.params_,o),this.updateV13_(),this.setKey(this.getKeyForParams_())},p.prototype.updateV13_=function(){var o=this.params_.VERSION||v.e;this.v13_=(0,L.n)(o,"1.3")>=0},p.prototype.tileUrlFunction=function(o,n,a){var l=this.getTileGrid();if(l||(l=this.getTileGridForProjection(a)),!(l.getResolutions().length<=o[0])){n!=1&&(!this.hidpi_||this.serverType_===void 0)&&(n=1);var f=l.getResolution(o[0]),d=l.getTileCoordExtent(o,this.tmpExtent_),u=(0,S.Pq)(l.getTileSize(o[0]),this.tmpSize),b=this.gutter_;b!==0&&(u=(0,S.f3)(u,b,this.tmpSize),d=(0,g.buffer)(d,f*b,d)),n!=1&&(u=(0,S.bA)(u,n,this.tmpSize));var m={SERVICE:"WMS",VERSION:v.e,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};return(0,y.f0)(m,this.params_),this.getRequestUrl_(o,u,d,n,a,m)}},p}(P.default);I.Z=C}}]);
