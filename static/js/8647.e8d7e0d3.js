"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[8647],{8647:function(P,n,a){a.r(n);var c=a(53183),E=a.n(c),f=a(14888),g=a(42447),h=a(55979),m=a(7522),l=a(44727),r=a(76094),d=a(13798),M=a(56828),O=a(13811),_=a(2487),D=a(55616),p=a.n(D),y=a(31954);class L{constructor(e,t,s){this.option=t,this.callback=s,this.option.mode="heat",this.map=e,this.parames=new h.Z,this.colorList=["#00f","#0ff","#0f0","#ff0","#f00"],this.option.colorList=this.colorList,this.loading}initHeat(){this.clearHeat(),this.option.action=="clear"?this.clearHeat():(this.loading=D.Loading.service({lock:!0,spinner:"visualizationLoading",background:"rgba(255, 255, 255, 0.7)"}),this.getHeatMapData())}getHeatMapData(){let e=this,t=y.Z.gisConfigJSON;if(t.toc&&t.toc.length>0){let s=t.toc,o=E().grep(s,function(u){return u.layerTag==e.option.layerTag})[0];e.queryFeatures(o)}else{if(e.callback){let s={success:!1,mode:e.option.mode,message:"\u56FE\u5C42\u4E0D\u5B58\u5728"};e.callback(s)}alert("\u56FE\u5C42\u4E0D\u5B58\u5728")}}queryFeatures(e){let t=this,s=new g.Z(e);t.parames.srsName=t.map.getView().getProjection().getCode(),t.parames.where=t.option.whereClause,s.execute(t.parames).then(function(i){if(i&&i.features&&i.features.length>0){let o=i.features;t.getPointArr(o),t.loadHeatLayer()}else{if(t.callback){let o={success:!1,mode:t.option.mode,message:"\u672A\u67E5\u8BE2\u5230\u6570\u636E"};t.callback(o)}alert("\u672A\u67E5\u8BE2\u5230\u6570\u636E")}})}getPointArr(e){this.pointFeatures=[],e.forEach(t=>{let s=t.geometry,i=s.type,o=null,u=null;if(i=="MultiPolygon")o=new m.Z(s.coordinates),u=(0,r.getCenter)(o.getExtent());else if(i=="Polygon")o=new l.ZP(s.coordinates),u=(0,r.getCenter)(o.getExtent());else if(i=="Point")u=s.coordinates;else return;this.pointFeatures.push(this.heatMapFeature(u))})}clearHeat(){f.Z.$emit("setLegend",this.option),this.map.getLayers().array_.forEach(t=>{t.values_.id=="heatMap"&&this.map.removeLayer(t)})}heatMapFeature(e){return new O.Z({geometry:new d.Z(e),weight:1})}loadHeatLayer(){let e=this,t=e.pointFeatures,s=e.heatLayer=e.createHeatMap({features:t,radius:8,gradient:e.colorList});if(e.map.addLayer(s),e.map.getView().fit(s.getSource().getExtent(),e.map.getSize()),e.callback){let i={success:!0,mode:e.option.mode,message:"\u6DFB\u52A0\u6210\u529F"};e.callback(i)}this.loading.close()}createHeatMap(e){var t=new M.Z({opacity:.7,zIndex:9999,source:new _.default({features:e.features}),renderModed:"image",id:"heatMap",extent:e.extent,weight:s,gradient:e.gradient,blur:25,radius:e.radius||8});function s(i){var o=i.get("weight");return o=parseFloat(o),o}return t}}n.default=L},55979:function(P,n){class a{constructor(){this.where,this.srsName,this.outputFormat="application/json",this.maxFeatures,this.startIndex,this.resultType}}n.Z=a},42447:function(P,n,a){var c=a(69787),E=a.n(c),f=a(53183),g=a.n(f);class h{constructor(l){this.layerOption=l}execute(l){let r={service:"wfs",version:"1.1.0",request:"GetFeature",typeName:this.layerOption.visibleLayers[0],outputFormat:l.outputFormat};return l.where&&(r.CQL_FILTER=l.where),l.srsName&&(r.srsName=l.srsName),l.startIndex&&(r.startIndex=l.startIndex),l.maxFeatures&&(r.maxFeatures=l.maxFeatures),l.resultType&&(r.resultType=l.resultType),new Promise((d,M)=>{let O=this.layerOption.identifyField[0].lyr+"/"+this.layerOption.visibleLayers[0].split(":")[0]+"/wfs";g().ajax({url:O,type:"POST",data:E().stringify(r),success:_=>{d(_)},error:_=>{M(_)}})})}}n.Z=h}}]);
