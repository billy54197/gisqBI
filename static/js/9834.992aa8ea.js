"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[9834],{29834:function(j,T,o){o.r(T),o.d(T,{default:function(){return z}});var A=function(){var t=this,e=t._self._c;return e("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"controlData",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"}},[e("hide-button",{attrs:{attr:t.widgetInfo.attr}}),e("el-popover",{attrs:{"popper-class":"controlData",trigger:t.widgetInfo.config.attributes.trigger,placement:t.widgetInfo.config.attributes.placement,"visible-arrow":t.widgetInfo.config.button.arrow,offset:t.widgetInfo.config.attributes.offset,transition:"el-fade-in",title:t.widgetInfo.config.attributes.title},model:{value:t.visible,callback:function(a){t.visible=a},expression:"visible"}},[e("div",{staticStyle:{width:"350px","min-height":"80px",padding:"5px"}},[e("el-form",{attrs:{"label-width":"90px"}},[e("el-form-item",{attrs:{label:"\u9009\u62E9\u6A21\u578B\uFF1A"}},[e("el-select",{staticStyle:{width:"90%"},attrs:{placeholder:"\u6A21\u578B\u5217\u8868",size:"small","popper-append-to-body":!1},on:{change:t.modelChange},model:{value:t.widgetInfo.config.modelId,callback:function(a){t.$set(t.widgetInfo.config,"modelId",a)},expression:"widgetInfo.config.modelId"}},t._l(t.modelList,function(a,p){return e("el-option",{key:p,attrs:{label:a.title,value:a.id}})}),1)],1),t.model?e("div",[e("div",{staticStyle:{padding:"5px 0"}},[e("div",{staticClass:"title"},[t._v(t._s(t.model.title))]),e("span",{staticClass:"description"},[t._v("\u6A21\u578B\u7684\u63CF\u8FF0\uFF1A"+t._s(t.model.desc))])]),e("el-card",{staticClass:"box-card"},[e("div",{staticClass:"process"},t._l(t.model.nodeList,function(a,p){return e("div",{key:p+"model"},[e("div",[e("el-row",[e("el-col",{attrs:{span:12}},[e("el-button",{staticStyle:{width:"100%",padding:"12px 0","pointer-events":"none"},attrs:{plain:""}},[t._v(" "+t._s(a.title+"("+a.alias+")")+" ")])],1),e("el-col",{attrs:{span:12}},[e("div",{staticClass:"description"},[t._v(t._s(a.desc))])])],1),t.model.nodeList[t.model.nodeList.length-1]!==a?e("p",{staticStyle:{width:"160px","text-align":"center"}},[e("i",{staticClass:"el-icon-bottom"})]):t._e()],1)])}),0),e("div",{class:Number(t.model.status)===2?"success":"error"},[t._v(" "+t._s(this.setStatus(t.model.status))+" ")])]),t.model.refParamList[0].type===1?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u8BF7\u5728\u5730\u56FE\u4E0A\u9009\u53D6\u9700\u8981\u5206\u6790\u7684\u8303\u56F4\uFF1A","label-width":"240px"}},[e("el-button",{staticStyle:{padding:"8px 20px"},attrs:{size:"mini",type:"primary"},on:{click:t.selectRange}},[t._v("\u9009\u53D6\u8303\u56F4 ")])],1):t._e(),t.model.refParamList[0].type===1?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u56FE\u5C42\u5730\u5740\uFF1A","label-width":"100px"}},[e("el-input",{model:{value:t.layerURL,callback:function(a){t.layerURL=a},expression:"layerURL"}}),e("el-button",{staticStyle:{padding:"8px 20px"},attrs:{size:"mini",type:"primary"},on:{click:t.addLayer}},[t._v("\u6DFB\u52A0\u56FE\u5C42 ")])],1):t._e(),t.model.refParamList[0].type===0?e("el-form-item",{staticStyle:{"text-align":"left",margin:"0"},attrs:{label:"\u8F93\u5165\u5B57\u7B26\u4E32\uFF1A","label-width":"100px"}},[e("el-input",{attrs:{size:"mini",placeholder:"\u8BF7\u8F93\u5165\u8981\u5206\u6790\u7684\u8303\u56F4"},on:{change:t.stringChange},model:{value:t.paramString,callback:function(a){t.paramString=a},expression:"paramString"}})],1):t._e(),e("el-form-item",{staticStyle:{"text-align":"center",margin:"0"},attrs:{"label-width":"0"}},[e("el-button",{staticStyle:{padding:"8px 30px"},attrs:{size:"mini",type:"primary"},on:{click:t.submit}},[t._v("\u83B7\u53D6\u5206\u6790\u7ED3\u679C ")])],1)],1):t._e()],1)],1),e("el-button",{style:t.btnStyle,attrs:{slot:"reference"},slot:"reference"})],1),e("el-dialog",{directives:[{name:"dialogDrag",rawName:"v-dialogDrag"}],attrs:{title:"\u5F53\u524D\u56FE\u5C42\u5206\u6790\u7ED3\u679C",visible:t.dialogVisible,"append-to-body":!0,top:"20vh","close-on-click-modal":!1,width:t.bigDialog?"50%":"30%",height:"300"},on:{"update:visible":function(a){t.dialogVisible=a}}},[e("el-table",{staticClass:"data-base-table",attrs:{data:t.gridData,size:"mini",height:"300"}},t._l(t.propData,function(a,p){return e("el-table-column",{key:p,attrs:{property:a,label:a,width:t.bigDialog?"160":""}})}),1)],1)],1)},R=[],O=o(27966),N=o(45061),P=o(26711),_=o(44513),S=o(35051),D=o(70709),U=o(55946),x=o(65148);let M=U.Z.state.view.viewType,I="/thirdparty/databrain",C={remoteproject(){return M==x.Z.editType.public.code?(0,D.xV)(I+"/remoteproject"):(0,S.getRequest)(I+"/remoteproject")},remotemodels(i){return M==x.Z.editType.public.code?(0,D.xV)(I+"/remotemodels/"+i):(0,S.getRequest)(I+"/remotemodels/"+i)},model(i){return M==x.Z.editType.public.code?(0,D.M0)(I+"/model/",i):(0,S.postRequest)(I+"/model/",i)}};var F=o(86892),E=o(57922),u=o(72449),s=o(13927),n=o(81121),r=o(2487),d=o(37564),h=o(82571),l=o(68640),c=o(23230),y=o(5689),m=o(55616),f=o(49500),g={name:"control-data",props:["widgetInfo"],components:{HideButton:_.Z},mixins:[N.u,P.H,F.D],data(){return{visible:!1,setDisabled:!1,model:null,paramString:"",modelList:[],dialogVisible:!1,map:null,timer:"",pickupLayer:null,pickupSource:null,draw:null,bigDialog:!1,propData:[],gridData:[],layerURL:"http://192.168.11.77:8080/geoserver/postgis/wfs?layer=postgis:CombinSD3",btnStyle:{backgroundColor:"#409eff",borderColor:"#409eff",backgroundImage:"url("+o(47648)+")",backgroundSize:"70% 70%",backgroundPosition:"center",backgroundRepeat:"no-repeat",width:"28px",height:"28px",opacity:1}}},mounted(){this.timer=setInterval(this.getBindMap,500),this.initAction(this.widgetInfo),this.loadInfo(this.widgetInfo)},methods:{loadInfo(i){this.widgetInfo.config.projectId&&this.getProjectList(this.widgetInfo.config.projectId);let t=i.config.imgIconConfig.img;t?(this.btnStyle.backgroundImage=`url(${t})`,this.btnStyle.backgroundSize=i.config.imgIconConfig.width+"px "+i.config.imgIconConfig.height+"px"):this.btnStyle.backgroundImage="url("+o(47648)+")",this.btnStyle.width=i.attr.w+"px",this.btnStyle.height=i.attr.h+"px",this.btnStyle.opacity=i.attr.opacity,i.attr.backgroundColor?this.btnStyle.backgroundColor=i.attr.backgroundColor:this.btnStyle.backgroundColor="#409eff"},reLoadInfo(i){i&&(this.$refs.controlData.style.width=i.attr.w+"px",this.$refs.controlData.style.height=i.attr.hh+"px"),this.loadInfo(i)},getBindMap(){window.shinemap&&(clearInterval(this.timer),this.map=window.shinemap,this.map&&(f.log("\u5927\u6570\u636E\u7EC4\u4EF6\u6355\u83B7map\u5BF9\u8C61\u6210\u529F\uFF0C\u5173\u95ED\u5B9A\u65F6\u5668\u5E76\u521D\u59CB\u5316\u5927\u6570\u636E\u62FE\u53D6\u8303\u56F4\u56FE\u5C42"),this.pickupSource=new r.default({wrapX:!1}),this.pickupLayer=new u.default({source:this.pickupSource,style:new h.ZP({fill:new l.Z({color:"rgba(255, 0, 0, 0)"}),stroke:new c.Z({color:"#FF0000",width:2}),image:new y.Z({radius:7,fill:new l.Z({color:"#ffcc33"})})}),zIndex:99}),this.map.addLayer(this.pickupLayer)))},initAction(i){this.actionReceive(i)},getProjectList(i){let t=this;C.remotemodels(i).then(e=>{if(t.modelList=e.data,this.widgetInfo.config.modelId){let a=this.$$lib__.find(this.modelList,p=>p.id==this.widgetInfo.config.modelId);a&&(this.model=a)}f.info(this.model)}).catch(e=>{f.log(e)})},modelChange(){if(this.widgetInfo.config.modelId){let i=this.$$lib__.find(this.modelList,t=>t.id==this.widgetInfo.config.modelId);i&&(this.model=i)}},stringChange(){},selectRange(){if(this.draw){this.map.removeInteraction(this.draw),this.draw=void 0;return}this.draw=new E.ZP({source:this.pickupSource,type:"Polygon"}),this.map.addInteraction(this.draw),this.feartures=[],this.draw.on("drawend",i=>{this.feartures.push(i.feature)})},addLayer(){this.map||(this.map=window.shinemap),this.map.getLayers().getArray().forEach(v=>{v.values_.id==="sd_layer"&&this.map.removeLayer(v)});let t=this.layerURL.split("?")[0],e=this.layerURL.split("?")[1].split("=")[1],a=[117.8842226380001,27.95433125200003,122.25971163300011,30.984672605000046];this.currentWkid=this.map.getView().getProjection().getCode();let p=new s.default({source:new n.Z({url:t,params:{LAYERS:e,VERSION:"1.1.0"},projection:this.currentWkid,serverType:"geoserver"})});this.map.addLayer(p),this.map.getView().fit(a,{size:this.map.getSize()})},submit(){let i=this.getRequestData(),t=new d.default().writeFeatures(this.feartures),e=JSON.parse(t);e.features.forEach(a=>{a.properties||(a.properties={})}),t=JSON.stringify(e),this.map.removeInteraction(this.draw),i.refParamList[0].value=t,this.executeModel(i)},getRequestData(){let i={modelId:"",pageHelper:{pageIndex:0,pageSize:50},refParamList:null};return i.modelId=this.model.id,i.refParamList=JSON.parse(JSON.stringify(this.model.refParamList)),this.$$lib__.each(i.refParamList,t=>{t.value=null}),JSON.parse(JSON.stringify(i))},executeModel(i){let t=this.$loading({lock:!0,text:"\u6B63\u5728\u5206\u6790\uFF0C\u8BF7\u7A0D\u540E...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"});C.model(i).then(e=>{t.close(),this.sendoutResponseData(e.data),this.showMapInfo(e.data)}).then(e=>{}).catch(e=>{f.log(e)})},showMapInfo(i){let t=this.getWidgetObject(this.widgetInfo.action.gisMapId),e={type:"FeatureCollection",features:[]};this.$$lib__.each(i.data,a=>{e.features.push(JSON.parse(a))}),t.$refs.gismap.map.locateGeoJson(JSON.stringify(e))},setButtonStyle(){return{backgroundColor:"#409eff",borderColor:"#409eff",backgroundImage:"url("+o(47648)+")",backgroundSize:"70% 70%",backgroundPosition:"center",backgroundRepeat:"no-repeat"}},setStatus(i){switch(Number(i)){case 0:return this.setDisabled=!0,"*\u6A21\u578B\u672A\u542F\u52A8";case 1:return this.setDisabled=!0,"*\u6A21\u578B\u542F\u52A8\u4E2D";case 2:return this.setDisabled=!1,"*\u6A21\u578B\u8FD0\u884C\u4E2D";case 3:return this.setDisabled=!0,"*\u6A21\u578B\u5DF2\u7EC8\u6B62"}},sendoutResponseData(i){let t=this,e=this.widgetInfo;this.$$lib__.each(e.action.sendOut.actionList,a=>{if(a.enabled&&a.code==t.$$global_editor.actionType.responseData.code){let p=a.code+"_"+e.id,v=i;if(a.script&&a.script.enabled){if(f.log("Execute script for "+a.name+" component to "+a.script.title+" component"),a.script.content==""){m.Message.warning({message:"\u81EA\u5B9A\u4E49\u811A\u672C\u5DF2\u542F\u7528\uFF0C\u4F46\u672A\u7F16\u5199\u4EFB\u4F55\u811A\u672C",offset:60});return}this.customScript_actionSend_responseData=new Function("param",a.script.content),v=this.customScript_actionSend_responseData(v)}O.Z.$emit(p,v),a.postMessage&&this.doPostMessage(v),this.actionNameList.push(p)}})},actionReceive(i){if(i.action==null||i.action.receive==null)return;let t=i.action.receive.executeModel;t&&t.enabled&&t.executeList&&t.executeList.length>0&&this.$$lib__.each(t.executeList,e=>{let a=e[0][1];O.Z.$on(a,p=>{i.action.receive.executeModel.script&&i.action.receive.executeModel.script.enabled&&(f.log("Execute the script to execute model to the "+i.name+" component"),this.actionExecuteModel=new Function("info","param","action",i.action.receive.executeModel.script.content)),this.actionExecuteModel(i,p,e)})})}},actionExecuteModel(i,t,e){f.debug(e);let a=this.getRequestData();this.$$lib__.each(a.refParamList,p=>{for(let v in t)p.name==v&&(p.value=t[v])}),this.executeModel(a)},directives:{dialogDrag:{bind(i){const t=i.querySelector(".el-dialog__header"),e=i.querySelector(".el-dialog"),a=window.getComputedStyle(e,null);t.style.cursor="move",t.onmousedown=p=>{const v=p.clientX-t.offsetLeft,V=p.clientY-t.offsetTop;let $,B;a.left.includes("%")?($=+document.body.clientWidth*(+parseFloat(a.left)/100),B=+document.body.clientHeight*(+parseFloat(a.top)/100)):($=+parseFloat(a.left),B=+parseFloat(a.top)),document.onmousemove=function(W){const Z=W.clientX-v,K=W.clientY-V;e.style.left=`${Z+$}px`,e.style.top=`${K+B}px`},document.onmouseup=function(){document.onmousemove=null,document.onmouseup=null}}}}},beforeDestroy(){clearInterval(this.timer)}},b=g,w=o(68141),L=(0,w.Z)(b,A,R,!1,null,"5041cb82",null),z=L.exports},47648:function(j,T,o){j.exports=o.p+"static/img/control-data.b890af02.png"},81121:function(j,T,o){var A=o(73608),R=o(45503),O=o(10416),N=o(12059),P=o(45059),_=o(76094),S=o(85606),D=o(61625),U=o(27794),x=o(90583),M=o(77767),I=o(2692),C=function(){var E=function(u,s){return E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var d in r)Object.prototype.hasOwnProperty.call(r,d)&&(n[d]=r[d])},E(u,s)};return function(u,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");E(u,s);function n(){this.constructor=u}u.prototype=s===null?Object.create(s):(n.prototype=s.prototype,new n)}}(),F=function(E){C(u,E);function u(s){var n=this,r=s||{},d=r.imageSmoothing!==void 0?r.imageSmoothing:!0;r.interpolate!==void 0&&(d=r.interpolate);var h=r.params||{},l="TRANSPARENT"in h?h.TRANSPARENT:!0;return n=E.call(this,{attributions:r.attributions,attributionsCollapsible:r.attributionsCollapsible,cacheSize:r.cacheSize,crossOrigin:r.crossOrigin,interpolate:d,opaque:!l,projection:r.projection,reprojectionErrorThreshold:r.reprojectionErrorThreshold,tileClass:r.tileClass,tileGrid:r.tileGrid,tileLoadFunction:r.tileLoadFunction,url:r.url,urls:r.urls,wrapX:r.wrapX!==void 0?r.wrapX:!0,transition:r.transition,zDirection:r.zDirection})||this,n.gutter_=r.gutter!==void 0?r.gutter:0,n.params_=h,n.v13_=!0,n.serverType_=r.serverType,n.hidpi_=r.hidpi!==void 0?r.hidpi:!0,n.tmpExtent_=(0,_.createEmpty)(),n.updateV13_(),n.setKey(n.getKeyForParams_()),n}return u.prototype.getFeatureInfoUrl=function(s,n,r,d){var h=(0,x.get)(r),l=this.getProjection(),c=this.getTileGrid();c||(c=this.getTileGridForProjection(h));var y=c.getZForResolution(n,this.zDirection),m=c.getTileCoordForCoordAndZ(s,y);if(!(c.getResolutions().length<=m[0])){var f=c.getResolution(m[0]),g=c.getTileCoordExtent(m,this.tmpExtent_),b=(0,S.Pq)(c.getTileSize(m[0]),this.tmpSize),w=this.gutter_;w!==0&&(b=(0,S.f3)(b,w,this.tmpSize),g=(0,_.buffer)(g,f*w,g)),l&&l!==h&&(f=(0,D.aA)(l,h,s,f),g=(0,x.transformExtent)(g,h,l),s=(0,x.transform)(s,h,l));var L={SERVICE:"WMS",VERSION:R.e,REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};(0,P.f0)(L,this.params_,d);var z=Math.floor((s[0]-g[0])/f),i=Math.floor((g[3]-s[1])/f);return L[this.v13_?"I":"X"]=z,L[this.v13_?"J":"Y"]=i,this.getRequestUrl_(m,b,g,1,l||h,L)}},u.prototype.getLegendUrl=function(s,n){if(this.urls[0]!==void 0){var r={SERVICE:"WMS",VERSION:R.e,REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(n===void 0||n.LAYER===void 0){var d=this.params_.LAYERS,h=!Array.isArray(d)||d.length===1;if(!h)return;r.LAYER=d}if(s!==void 0){var l=this.getProjection()?this.getProjection().getMetersPerUnit():1,c=28e-5;r.SCALE=s*l/c}return(0,P.f0)(r,n),(0,O.B)(this.urls[0],r)}},u.prototype.getGutter=function(){return this.gutter_},u.prototype.getParams=function(){return this.params_},u.prototype.getRequestUrl_=function(s,n,r,d,h,l){var c=this.urls;if(c){if(l.WIDTH=n[0],l.HEIGHT=n[1],l[this.v13_?"CRS":"SRS"]=h.getCode(),"STYLES"in this.params_||(l.STYLES=""),d!=1)switch(this.serverType_){case"geoserver":var y=90*d+.5|0;"FORMAT_OPTIONS"in l?l.FORMAT_OPTIONS+=";dpi:"+y:l.FORMAT_OPTIONS="dpi:"+y;break;case"mapserver":l.MAP_RESOLUTION=90*d;break;case"carmentaserver":case"qgis":l.DPI=90*d;break;default:(0,N.h)(!1,52);break}var m=h.getAxisOrientation(),f=r;if(this.v13_&&m.substr(0,2)=="ne"){var g=void 0;g=r[0],f[0]=r[1],f[1]=g,g=r[2],f[2]=r[3],f[3]=g}l.BBOX=f.join(",");var b;if(c.length==1)b=c[0];else{var w=(0,M.$W)((0,I.vp)(s),c.length);b=c[w]}return(0,O.B)(b,l)}},u.prototype.getTilePixelRatio=function(s){return!this.hidpi_||this.serverType_===void 0?1:s},u.prototype.getKeyForParams_=function(){var s=0,n=[];for(var r in this.params_)n[s++]=r+"-"+this.params_[r];return n.join("/")},u.prototype.updateParams=function(s){(0,P.f0)(this.params_,s),this.updateV13_(),this.setKey(this.getKeyForParams_())},u.prototype.updateV13_=function(){var s=this.params_.VERSION||R.e;this.v13_=(0,U.n)(s,"1.3")>=0},u.prototype.tileUrlFunction=function(s,n,r){var d=this.getTileGrid();if(d||(d=this.getTileGridForProjection(r)),!(d.getResolutions().length<=s[0])){n!=1&&(!this.hidpi_||this.serverType_===void 0)&&(n=1);var h=d.getResolution(s[0]),l=d.getTileCoordExtent(s,this.tmpExtent_),c=(0,S.Pq)(d.getTileSize(s[0]),this.tmpSize),y=this.gutter_;y!==0&&(c=(0,S.f3)(c,y,this.tmpSize),l=(0,_.buffer)(l,h*y,l)),n!=1&&(c=(0,S.bA)(c,n,this.tmpSize));var m={SERVICE:"WMS",VERSION:R.e,REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};return(0,P.f0)(m,this.params_),this.getRequestUrl_(s,c,l,n,r,m)}},u}(A.default);T.Z=F}}]);
