"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[9869],{83574:function(H,p,i){var v=i(19534);Object.defineProperty(p,"__esModule",{value:!0}),p.default=void 0;var y=v(i(28866)),u=v(i(42579)),M={data:function(){return{isSetMap_common:!1}},inject:{reactiveConfigInstance:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},reactiveViewMode:{default:function(){var r=this;return function(){return(0,u.default)(this,r),"23D"}.bind(this)}},reactiveView:{default:function(){var r=this;return function(){return(0,u.default)(this,r),"map"}.bind(this)}},reactiveMap:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},reactiveEarth:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},reactiveInteraction:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},reactiveShinegaUrl:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},reactiveShinegaDatabaseId:{default:function(){var r=this;return function(){return(0,u.default)(this,r),null}.bind(this)}},shinegaInitData:{default:null},token:{default:null},emitterId:{default:null},fastApplicationId:{default:null},publishId:{default:null}},computed:{configInstance:function(){return this.reactiveConfigInstance()},$map:function(){return this.isSetMap_common?this.$_map:this.reactiveMap()},$earth:function(){return this.isSetMap_common?this.$_earth:this.reactiveEarth()},viewMode:function(){return this.isSetMap_common?this.$_viewMode:this.reactiveViewMode()},currentView:function(){return this.reactiveView()},currentInteraction:function(){return this.reactiveInteraction()},shinegaUrl:function(){return this.reactiveShinegaUrl()},shinegaDatabaseId:function(){return this.reactiveShinegaDatabaseId()}},methods:{setMap:function(r){var S=(0,y.default)(r),C=r.earth,o=r.viewMode;this.$_map=S,this.$_earth=C,this.$_viewMode=o,this.isSetMap_common=!0,this.begin&&this.begin()}}},z=M;p.default=z},42709:function(H,p,i){var v=i(48836);const y={data(){return this.map=null,this.timer="",{isEditor:window.location.href.indexOf("editor.html")>0}},inject:{reactiveViewMode:{default:function(){return()=>"23D"}}},computed:{viewMode(){return this.isSetMap_common?this.$_viewMode:this.reactiveViewMode()}},mounted(){!this.widgetInfo.parentId&&this.isEditor&&this.widgetInfo.action.gisMapId&&this.$nextTick(function(){this.updateWidgetParentId({widgetId:this.widgetInfo.id,parentId:this.widgetInfo.action.gisMapId,keepPosition:!0})})},methods:{...(0,v.nv)(["updateWidgetParentId"]),getBindMap(){typeof this.widgetInfo.action.gisMapId<"u"}}};p.Z=y},44513:function(H,p,i){i.d(p,{Z:function(){return S}});var v=function(){var o=this,x=o._self._c;return o.attr.buttonHide?x("div",{style:{position:"absolute",right:o.attr.buttonHideRight+"px",top:o.attr.buttonHideTop+"px",width:"30px",height:"25px",cursor:"pointer",zIndex:"9999"},on:{click:function(E){return o.onHide()}}},[o.openTooltip?x("el-tooltip",{attrs:{"open-delay":1e3,content:o.attr.buttonHideTooltipContent,effect:"dark",placement:"top"}},[x("el-button",{class:o.attr.buttonHideIconClass&&o.attr.buttonHideIconClass!=""?o.attr.buttonHideIconClass:"iconfont bi_eyeslash",staticStyle:{"margin-left":"6px",padding:"3px 0",width:"15px",height:"15px"},style:{color:o.attr.buttonHideColor,fontSize:o.attr.buttonHideIconFontSize+"px"},attrs:{size:"small",type:"text"}})],1):x("el-button",{class:o.attr.buttonHideIconClass&&o.attr.buttonHideIconClass!=""?o.attr.buttonHideIconClass:"iconfont bi_eyeslash",staticStyle:{"margin-left":"6px",padding:"3px 0",width:"15px",height:"15px"},style:{color:o.attr.buttonHideColor,fontSize:o.attr.buttonHideIconFontSize+"px"},attrs:{size:"small",type:"text"}})],1):o._e()},y=[],u=i(52246),M={props:["attr"],name:"hide-button",data(){return{isPc:u.b}},computed:{openTooltip:function(){let C=!1,o=this.attr.buttonHideTooltipContent;return u.b&&o&&o!=null&&o.trim()!=""&&(C=!0),C}},methods:{onHide(){this.attr.hide=!0,this.$emit("sendButtonHide")}}},z=M,l=i(68141),r=(0,l.Z)(z,v,y,!1,null,"bf399b9a",null),S=r.exports},79869:function(H,p,i){i.r(p),i.d(p,{default:function(){return R}});var v=function(){var t=this,n=t._self._c;return n("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"gis-theme-cluster",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"}},[n("hide-button",{attrs:{attr:t.widgetInfo.attr}})],1)},y=[],u=i(44513),M=i(27966),z=i(45061),l=i(26711),r=i(86892),S=i(42709),C=i(83574),o=i(53946),x=i(37564),E=i(31751),P=i(72449),D=i(2487),Z=i(82571),j=i(95659),N=i(23230),L=i(68640),T=i(81078),V=i(45617),G=i.n(V);class k{constructor(t,n,e){this.map=t,this.mapView=t.getView(),this.callback=e,this.geoJSON=new x.default,this.esrijsonFormat=new E.Z,this.wktFormat=new T.Z,this.mapId=this.map.getTarget().id,this.currentZoom=7,this.onClickListener=n}initMapCategorize(t){t&&t.isBiData?this.parseBiData(t):this.parseGeoJson()}parseBiData(t){this.clear(),this.options=t;const n=t.data;this.typeField=t.typeField,this.wkidField=t.wkidField,this.nameField=t.nameField;let e=t.geomField;const s=t.infoFields||[],d=[],a=this.mapView.getProjection().getCode();n.forEach(c=>{e||(e=this.getGeomField(c));let h=c[e];if(h){h=this.handleGeom(h);const I=c[this.wkidField]||"4490",g=this.wktFormat.readFeature(h,{dataProjection:`EPSG:${I}`,featureProjection:a}),m={};let b=this.nameField?c[this.nameField]:"",w=this.typeField?c[this.typeField]:"";s.forEach(F=>{F!==e&&(m[F]=c[F])}),g.setProperties(m),b&&(g.name=b),w&&(g.typeName=w),d.push(g)}}),d.length>0&&this._addLayer(d)}handleGeom(t){return t.startsWith("(( ")?t=t.replace("(( ","POLYGON(("):t.startsWith("((( ")&&(t=t.replace("((( ","MULTIPOLYGON((")),t=t.replace(" (( ","(("),t=t.replace(" ((( ","((("),t=t.replace("  (( ","(("),t=t.replace("  ((( ","((("),t}getGeomField(t){const n=Object.keys(t);let e="";return n.forEach(s=>{const d=t[s];if(typeof d=="string"){const a=d.toLowerCase();(a.startsWith("polygon")||a.startsWith("multipolygon")||a.startsWith("linestring")||a.startsWith("multilinestring"))&&(e=s)}}),e}parseGeoJson(){}_addLayer(t){const n=new D.default;n.addFeatures(t);const e=this.options.styleOption,s=this.options.nameField,d=this.options.typeField;let a=new P.default({id:"mapCategorize_"+this.newGuid(),source:n,zIndex:9999,style:h=>this._getStyle(h,s,d,e)});this.map.addLayer(a);let c=n.getExtent();this.fit2Map(c),this._clickListener(n)}fit2Map(t){let n=this.map.getSize();!t.includes(1/0)&&!t.includes(-1/0)&&this.mapView.fit(t,{size:n,duration:800})}_getStyle(t,n,e,s){const d=t.name||"",a=t.typeName||"",c=s[a]?s[a].fillColor:"",h=s[a]?s[a].strokeColor:"",I=s[a]?s[a].strokeWidth:"",g=s[a]?s[a].textFont:"",m=s[a]?s[a].textFill:"";let b=new L.Z({color:c||"rgba(28,77,255,0.4)"}),w=new N.Z({color:h||"#FF0000",width:I===void 0?2:I}),F=new j.Z({text:d,font:g||"16px bold Microsoft YaHei ",fill:new L.Z({color:m||"#FFF"})}),$=new Z.ZP({fill:b,stroke:w});return $.setText(F),$}clear(){let t=this.map.getLayers().getArray();if(t.length>0){let n=[];t.forEach(e=>{e.values_.id.includes("mapCategorize_")&&n.push(e)}),n.forEach(e=>{this.map.removeLayer(e)})}}_clickListener(t){this.map.on("click",n=>{const e=n.coordinate;let s=t.getFeaturesAtCoordinate(e);if(s.length===0){const a=e[0]+1e-5,c=e[1]+1e-5,h=e[0]-1e-5,I=e[1]-1e-5,g=[h,I,a,c];s=t.getFeaturesInExtent(g)}const d=[];s.forEach(a=>{const c=a.getProperties(),h=JSON.parse(JSON.stringify(c));delete h.geometry,d.push(h)}),this.onClickListener(d)})}newGuid(){return G().v4().replace(/-/g,"")}}var W=i(49500),A={name:"GisThemeCategorize",components:{HideButton:u.Z},mixins:[o.Z,r.D,z.u,l.H,S.Z,C.default],props:["widgetInfo"],data(){return this.mapCategorize,{xzqdm:null,zoomwatch:!1,actionName:null,actionParam:null,isPostMessage:null}},beforeDestroy(){this.mapCategorize&&this.mapCategorize.clear()},mounted(){this.$nextTick(()=>{this.initMapCategorize(),this.initAction(this.widgetInfo),this.loadInfo(this.widgetInfo)})},methods:{loadInfo(f){},reLoadInfo(f){this.loadInfo(f),this.initMapCategorize()},initAction(f){this.actionSendout(f),this.actionReceive(f)},initMapCategorize(){this.$map&&(this.mapCategorize=new k(this.$map,this.categorizeClick),this.initConfigData(),this.mapCategorize.initMapCategorize(this.widgetInfo.config))},initConfigData(){const f=this.widgetInfo.dataset.type||"",n=(this.widgetInfo.dataset||{})[f]||{},e=n.dimensionsAlias,s=n.source,d=[],a=n.encode.typeField,c=n.encode.geomField,h=n.encode.wkidField,I=n.encode.infoFields,g=n.encode.nameField,m=[];s.forEach(b=>{const w={};b.forEach(($,U)=>{const Y=e[U];w[Y.name]=$}),d.push(w);const F=w[a]||"\u5176\u4ED6";m.includes(F)||m.push(F)}),M.Z.$emit("categorizeChange",m),this.widgetInfo.config.typeField=a,this.widgetInfo.config.geomField=c,this.widgetInfo.config.wkidField=h,this.widgetInfo.config.infoFields=I,this.widgetInfo.config.nameField=g,this.widgetInfo.config.data=d},doShow(){this.initMapCategorize()},doHide(){this.mapCategorize&&this.mapCategorize.clear()},categorizeClick(f){let t=this;W.log(f);let n=this.widgetInfo.action.sendOut.actionList;this.$$lib__.each(n,e=>{if(e.enabled&&e.code==t.$$global_editor.actionType.categorizeClick.code){let s=e.code+"_"+t.widgetInfo.id,d={data:f};if(e.paramsExtend&&e.paramsExtend.length>0&&this.getExtendParams(d,e.paramsExtend,f,[]),e.script&&e.script.enabled&&e.script.content){this.doConfigMap=new Function("data",e.script.content);let a=this.doConfigMap(d);a&&(d=a)}M.Z.$emit(s,d),e.postMessage&&this.doPostMessage(d),this.actionNameList.push(s)}})}}},O=A,B=i(68141),J=(0,B.Z)(O,v,y,!1,null,"d75d99d2",null),R=J.exports}}]);
