"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[79869],{783574:function(P,g,i){var u=i(419534);Object.defineProperty(g,"__esModule",{value:!0}),g.default=void 0;var m=u(i(828866)),r=u(i(342579)),x={data:function(){return{isSetMap_common:!1}},inject:{reactiveConfigInstance:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},reactiveViewMode:{default:function(){var d=this;return function(){return(0,r.default)(this,d),"23D"}.bind(this)}},reactiveView:{default:function(){var d=this;return function(){return(0,r.default)(this,d),"map"}.bind(this)}},reactiveMap:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},reactiveEarth:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},reactiveInteraction:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},reactiveShinegaUrl:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},reactiveShinegaDatabaseId:{default:function(){var d=this;return function(){return(0,r.default)(this,d),null}.bind(this)}},shinegaInitData:{default:null},token:{default:null},emitterId:{default:null},fastApplicationId:{default:null},publishId:{default:null}},computed:{configInstance:function(){return this.reactiveConfigInstance()},$map:function(){return this.isSetMap_common?this.$_map:this.reactiveMap()},$earth:function(){return this.isSetMap_common?this.$_earth:this.reactiveEarth()},viewMode:function(){return this.isSetMap_common?this.$_viewMode:this.reactiveViewMode()},currentView:function(){return this.reactiveView()},currentInteraction:function(){return this.reactiveInteraction()},shinegaUrl:function(){return this.reactiveShinegaUrl()},shinegaDatabaseId:function(){return this.reactiveShinegaDatabaseId()}},methods:{setMap:function(d){var S=(0,m.default)(d),C=d.earth,o=d.viewMode;this.$_map=S,this.$_earth=C,this.$_viewMode=o,this.isSetMap_common=!0,this.begin&&this.begin()}}},z=x;g.default=z},242709:function(P,g,i){var u=i(148836);const m={data(){return this.map=null,this.timer="",{isEditor:window.location.href.indexOf("editor.html")>0}},inject:{reactiveViewMode:{default:function(){return()=>"23D"}}},computed:{viewMode(){return this.isSetMap_common?this.$_viewMode:this.reactiveViewMode()}},mounted(){!this.widgetInfo.parentId&&this.isEditor&&this.widgetInfo.action.gisMapId&&this.$nextTick(function(){this.updateWidgetParentId({widgetId:this.widgetInfo.id,parentId:this.widgetInfo.action.gisMapId,keepPosition:!0})})},methods:{...(0,u.nv)(["updateWidgetParentId"]),getBindMap(){typeof this.widgetInfo.action.gisMapId<"u"}}};g.Z=m},752246:function(P,g,i){i.d(g,{X:function(){return u},b:function(){return m}});let u={versions:function(){var r=navigator.userAgent;return{trident:r.indexOf("Trident")>-1,presto:r.indexOf("Presto")>-1,webKit:r.indexOf("AppleWebKit")>-1,gecko:r.indexOf("Gecko")>-1&&r.indexOf("KHTML")==-1,mobile:!!r.match(/AppleWebKit.*Mobile.*/),ios:!!r.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:r.indexOf("Android")>-1,iPhone:r.indexOf("iPhone")>-1,iPad:r.indexOf("iPad")>-1,webApp:r.indexOf("Safari")==-1}}(),language:(navigator.browserLanguage||navigator.language).toLowerCase()},m;u.versions.mobile||u.versions.ios||u.versions.android||u.versions.iPhone||u.versions.iPad?m=!1:m=!0},844513:function(P,g,i){i.d(g,{Z:function(){return S}});var u=function(){var o=this,y=o._self._c;return o.attr.buttonHide?y("div",{style:{position:"absolute",right:o.attr.buttonHideRight+"px",top:o.attr.buttonHideTop+"px",width:"30px",height:"25px",cursor:"pointer",zIndex:"9999"},on:{click:function($){return o.onHide()}}},[o.openTooltip?y("el-tooltip",{attrs:{"open-delay":1e3,content:o.attr.buttonHideTooltipContent,effect:"dark",placement:"top"}},[y("el-button",{class:o.attr.buttonHideIconClass&&o.attr.buttonHideIconClass!=""?o.attr.buttonHideIconClass:"iconfont bi_eyeslash",staticStyle:{"margin-left":"6px",padding:"3px 0",width:"15px",height:"15px"},style:{color:o.attr.buttonHideColor,fontSize:o.attr.buttonHideIconFontSize+"px"},attrs:{size:"small",type:"text"}})],1):y("el-button",{class:o.attr.buttonHideIconClass&&o.attr.buttonHideIconClass!=""?o.attr.buttonHideIconClass:"iconfont bi_eyeslash",staticStyle:{"margin-left":"6px",padding:"3px 0",width:"15px",height:"15px"},style:{color:o.attr.buttonHideColor,fontSize:o.attr.buttonHideIconFontSize+"px"},attrs:{size:"small",type:"text"}})],1):o._e()},m=[],r=i(752246),x={props:["attr"],name:"hide-button",data(){return{isPc:r.b}},computed:{openTooltip:function(){let C=!1,o=this.attr.buttonHideTooltipContent;return r.b&&o&&o!=null&&o.trim()!=""&&(C=!0),C}},methods:{onHide(){this.attr.hide=!0,this.$emit("sendButtonHide")}}},z=x,c=i(768141),d=(0,c.Z)(z,u,m,!1,null,"bf399b9a",null),S=d.exports},879869:function(P,g,i){i.r(g),i.d(g,{default:function(){return J}});var u=function(){var t=this,n=t._self._c;return n("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"gis-theme-cluster",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"}},[n("hide-button",{attrs:{attr:t.widgetInfo.attr}})],1)},m=[],r=i(844513),x=i(927966),z=i(445061),c=i(126711),d=i(386892),S=i(242709),C=i(783574),o=i(753946),y=i(337564),$=i(131751),E=i(372449),O=i(2487),D=i(682571),T=i(195659),j=i(23230),H=i(568640),A=i(581078),N=i(645617),Z=i.n(N);class k{constructor(t,n,e){this.map=t,this.mapView=t.getView(),this.callback=e,this.geoJSON=new y.default,this.esrijsonFormat=new $.Z,this.wktFormat=new A.Z,this.mapId=this.map.getTarget().id,this.currentZoom=7,this.onClickListener=n}initMapCategorize(t){t&&t.isBiData?this.parseBiData(t):this.parseGeoJson()}parseBiData(t){this.clear(),this.options=t;const n=t.data;this.typeField=t.typeField,this.wkidField=t.wkidField,this.nameField=t.nameField;let e=t.geomField;const s=t.infoFields||[],l=[],a=this.mapView.getProjection().getCode();n.forEach(h=>{e||(e=this.getGeomField(h));let f=h[e];if(f){f=this.handleGeom(f);const I=h[this.wkidField]||"4490",v=this.wktFormat.readFeature(f,{dataProjection:`EPSG:${I}`,featureProjection:a}),w={};let M=this.nameField?h[this.nameField]:"",F=this.typeField?h[this.typeField]:"";s.forEach(b=>{b!==e&&(w[b]=h[b])}),v.setProperties(w),M&&(v.name=M),F&&(v.typeName=F),l.push(v)}}),l.length>0&&this._addLayer(l)}handleGeom(t){return t.startsWith("(( ")?t=t.replace("(( ","POLYGON(("):t.startsWith("((( ")&&(t=t.replace("((( ","MULTIPOLYGON((")),t=t.replace(" (( ","(("),t=t.replace(" ((( ","((("),t=t.replace("  (( ","(("),t=t.replace("  ((( ","((("),t}getGeomField(t){const n=Object.keys(t);let e="";return n.forEach(s=>{const l=t[s];if(typeof l=="string"){const a=l.toLowerCase();(a.startsWith("polygon")||a.startsWith("multipolygon")||a.startsWith("linestring")||a.startsWith("multilinestring"))&&(e=s)}}),e}parseGeoJson(){}_addLayer(t){const n=new O.default;n.addFeatures(t);const e=this.options.styleOption,s=this.options.nameField,l=this.options.typeField;let a=new E.default({id:"mapCategorize_"+this.newGuid(),source:n,zIndex:9999,style:f=>this._getStyle(f,s,l,e)});this.map.addLayer(a);let h=n.getExtent();this.fit2Map(h),this._clickListener(n)}fit2Map(t){let n=this.map.getSize();!t.includes(1/0)&&!t.includes(-1/0)&&this.mapView.fit(t,{size:n,duration:800})}_getStyle(t,n,e,s){const l=t.name||"",a=t.typeName||"",h=s[a]?s[a].fillColor:"",f=s[a]?s[a].strokeColor:"",I=s[a]?s[a].strokeWidth:"",v=s[a]?s[a].textFont:"",w=s[a]?s[a].textFill:"";let M=new H.Z({color:h||"rgba(28,77,255,0.4)"}),F=new j.Z({color:f||"#FF0000",width:I===void 0?2:I}),b=new T.Z({text:l,font:v||"16px bold Microsoft YaHei ",fill:new H.Z({color:w||"#FFF"})}),L=new D.ZP({fill:M,stroke:F});return L.setText(b),L}clear(){let t=this.map.getLayers().getArray();if(t.length>0){let n=[];t.forEach(e=>{e.values_.id.includes("mapCategorize_")&&n.push(e)}),n.forEach(e=>{this.map.removeLayer(e)})}}_clickListener(t){this.map.on("click",n=>{const e=n.coordinate;let s=t.getFeaturesAtCoordinate(e);if(s.length===0){const a=e[0]+1e-5,h=e[1]+1e-5,f=e[0]-1e-5,I=e[1]-1e-5,v=[f,I,a,h];s=t.getFeaturesInExtent(v)}const l=[];s.forEach(a=>{const h=a.getProperties(),f=JSON.parse(JSON.stringify(h));delete f.geometry,l.push(f)}),this.onClickListener(l)})}newGuid(){return Z().v4().replace(/-/g,"")}}var G=i(149500),V={name:"GisThemeCategorize",components:{HideButton:r.Z},mixins:[o.default,d.D,z.u,c.H,S.Z,C.default],props:["widgetInfo"],data(){return this.mapCategorize,{xzqdm:null,zoomwatch:!1,actionName:null,actionParam:null,isPostMessage:null}},beforeDestroy(){this.mapCategorize&&this.mapCategorize.clear()},mounted(){this.$nextTick(()=>{this.initMapCategorize(),this.initAction(this.widgetInfo),this.loadInfo(this.widgetInfo)})},methods:{loadInfo(p){},reLoadInfo(p){this.loadInfo(p),this.initMapCategorize()},initAction(p){this.actionSendout(p),this.actionReceive(p)},initMapCategorize(){this.$map&&(this.mapCategorize=new k(this.$map,this.categorizeClick),this.initConfigData(),this.mapCategorize.initMapCategorize(this.widgetInfo.config))},initConfigData(){const p=this.widgetInfo.dataset.type||"",n=(this.widgetInfo.dataset||{})[p]||{},e=n.dimensionsAlias,s=n.source,l=[],a=n.encode.typeField,h=n.encode.geomField,f=n.encode.wkidField,I=n.encode.infoFields,v=n.encode.nameField,w=[];s.forEach(M=>{const F={};M.forEach((L,K)=>{const R=e[K];F[R.name]=L}),l.push(F);const b=F[a]||"\u5176\u4ED6";w.includes(b)||w.push(b)}),x.Z.$emit("categorizeChange",w),this.widgetInfo.config.typeField=a,this.widgetInfo.config.geomField=h,this.widgetInfo.config.wkidField=f,this.widgetInfo.config.infoFields=I,this.widgetInfo.config.nameField=v,this.widgetInfo.config.data=l},doShow(){this.initMapCategorize()},doHide(){this.mapCategorize&&this.mapCategorize.clear()},categorizeClick(p){let t=this;G.log(p);let n=this.widgetInfo.action.sendOut.actionList;this.$$lib__.each(n,e=>{if(e.enabled&&e.code==t.$$global_editor.actionType.categorizeClick.code){let s=e.code+"_"+t.widgetInfo.id,l={data:p};if(e.paramsExtend&&e.paramsExtend.length>0&&this.getExtendParams(l,e.paramsExtend,p,[]),e.script&&e.script.enabled&&e.script.content){this.doConfigMap=new Function("data",e.script.content);let a=this.doConfigMap(l);a&&(l=a)}x.Z.$emit(s,l),e.postMessage&&this.doPostMessage(l),this.actionNameList.push(s)}})}}},W=V,B=i(768141),U=(0,B.Z)(W,u,m,!1,null,"d75d99d2",null),J=U.exports}}]);
