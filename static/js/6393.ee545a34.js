"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[6393],{26393:function(Ge,U,f){var L=f(65557),Se=f(85208),ge=f(59791),Ee=f(22466),ye=f(83393),xe=f(5077),N=f(19534);Object.defineProperty(U,"__esModule",{value:!0}),U.default=U.IdentifyEvent=U.IdentifyActiveEvent=U.Identify3DEvent=void 0;var Ce=N(f(18853)),F=N(f(43389)),te=N(f(87507)),X=N(f(42762)),re=N(f(22777)),Y=N(f(30044)),Oe=N(f(99085)),fe=N(f(34009)),Ae=N(f(7165)),pe=N(f(12207)),me=f(28222);function W(H,P){var C=Se(H);if(ge){var m=ge(H);P&&(m=Ee(m).call(m,function(x){return ye(H,x).enumerable})),C.push.apply(C,m)}return C}function je(H){for(var P=1;P<arguments.length;P++){var C=arguments[P]!=null?arguments[P]:{};P%2?W(Object(C),!0).forEach(function(m){(0,F.default)(H,m,C[m])}):xe?Object.defineProperties(H,xe(C)):W(Object(C)).forEach(function(m){Object.defineProperty(H,m,ye(C,m))})}return H}function J(H){var P=we();return function(){var m=(0,fe.default)(H),x;if(P){var w=(0,fe.default)(this).constructor;x=L(m,arguments,w)}else x=m.apply(this,arguments);return(0,Oe.default)(this,x)}}function we(){if(typeof Reflect>"u"||!L||L.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(L(Boolean,[],function(){})),!0}catch{return!1}}var E={strokeWidth:3,fillAlpha:.5,fill:"#ff0000",stroke:"#ff0000"},se={CHANGEACTIVE:"change:active",IDEHTIFYED:"identifyed",IDEHTIFYEDALL:"identifyedAll",IDEHTIFYED3D:"identifyed3d",IDEHTIFYEDALL3D:"identifyedAll3d"},ve=function(H){(0,Y.default)(C,H);var P=J(C);function C(m,x,w){var A;return(0,re.default)(this,C),A=P.call(this,m),A.active=x,A.identifyType=w,A}return(0,X.default)(C)}(pe.default);U.IdentifyActiveEvent=ve;var t=function(H){(0,Y.default)(C,H);var P=J(C);function C(m,x,w,A){var j;return(0,re.default)(this,C),j=P.call(this,m),j.result=x,j.coordinate=w,j.queryId=A,j}return(0,X.default)(C)}(pe.default);U.IdentifyEvent=t;var Q=function(H){(0,Y.default)(C,H);var P=J(C);function C(m,x,w,A){var j;return(0,re.default)(this,C),j=P.call(this,m),j.result=x,j.coordinate=w,j.queryId=A,j}return(0,X.default)(C)}(pe.default);U.Identify3DEvent=Q;var R=function(H){(0,Y.default)(C,H);var P=J(C);function C(m){var x;return(0,re.default)(this,C),x=P.call(this),x.active=!1,x.earth=m,x._popup=new me.Popup(x.earth.viewer),x.earthIdentifyed=x.earthIdentifyed.bind((0,te.default)(x)),x.earthIdentifyedAll=x.earthIdentifyedAll.bind((0,te.default)(x)),x}return(0,X.default)(C,[{key:"init",value:function(){var x=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"click";this.earth&&this.initEarthIdentify(),this.active=!0,this.dispatchEvent(new ve(se.CHANGEACTIVE,this.active,x))}},{key:"initEarthIdentify",value:function(){this._popup.pickOpen=!0,this._popup.popupShow=!0,this._popup.identifyed.addEventListener(this.earthIdentifyed),this._popup.identifyedAll.addEventListener(this.earthIdentifyedAll),this._popup.activate()}},{key:"earthIdentifyed",value:function(x,w,A){this.dispatchEvent(new Q(se.IDEHTIFYED3D,x,w,A))}},{key:"earthIdentifyedAll",value:function(x,w,A){this.dispatchEvent(new Q(se.IDEHTIFYEDALL3D,x,w,A))}},{key:"clearHighLight",value:function(){this._popup.removeFeature(),this._popup.unHighlighPick()}},{key:"highLightFeature",value:function(x){var w=je({},x);w.pickedObject&&(w.pickedObject=this._popup.pickedObjects[w.pickedObject]);var A=E;if(w.identifyField||(w.identifyField={}),w.identifyField.pickfeaturestyle){var j=w.identifyField.pickfeaturestyle,$=j.outlineWidth,Pe=j.opacity,ee=j.color,Fe=j.outlineColor;A.strokeWidth=$,A.fillAlpha=Pe/100,A.fill=ee,A.stroke=Fe}w.geometry&&w.layerInfo.type!=="feature"&&w.layerInfo.type!=="feature-pbf"&&w.layerInfo.type!=="geoserver-wfs"?this._popup.showFeature(JSON.parse(w.geometry),A):(w.identifyField.pickfeaturestyle||(w.identifyField.pickfeaturestyle={outlineWidth:E.strokeWidth,opacity:E.fillAlpha*100,color:(0,Ce.default)(E),outlineColor:E.stroke}),this._popup.highlighPick(w))}},{key:"setActive",value:function(x){var w=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"click";x?this.init(w):this.active&&this.cancel()}},{key:"cancel",value:function(){this.earth&&(this._popup.identifyed.removeEventListener(this.earthIdentifyed),this._popup.identifyedAll.removeEventListener(this.earthIdentifyedAll),this._popup.destroy()),this.active=!1,this.dispatchEvent(new ve(se.CHANGEACTIVE,this.active))}}]),C}(Ae.default),He=R;U.default=He},28222:function(Ge,U,f){var L=f(49500),Se=f(29870),ge=f(20314),Ee=f(26352),ye=f(40639),xe=f(43586),N=f(87879),Ce=f(83393),F=f(19534);Object.defineProperty(U,"__esModule",{value:!![]}),U.Popup=void 0;var te=F(f(11323)),X=F(f(5146)),re=F(f(28954)),Y=F(f(22466)),Oe=F(f(81806)),fe=F(f(26541)),Ae=F(f(78756)),pe=F(f(85208)),me=F(f(66273)),W=F(f(18853)),je=F(f(53267)),J=F(f(29870)),we=F(f(34749)),E=F(f(42579)),se=F(f(22777)),ve=F(f(42762)),t=ee(f(87647)),Q=ee(f(3852)),R=F(f(63379)),He=F(f(49162)),H=f(25794),P=ee(f(92672)),C=ee(f(80823)),m=f(31984),x=ee(f(69471)),w=ee(f(96535)),A=f(1117),j=f(3674),$=f(36161);function Pe(c){if(typeof N!="function")return null;var p=new N,e=new N;return(Pe=function(o){return o?e:p})(c)}function ee(c,p){if(!p&&c&&c.__esModule)return c;if(c===null||Se(c)!=="object"&&typeof c!="function")return{default:c};var e=Pe(p);if(e&&e.has(c))return e.get(c);var i={},o=Object.defineProperty&&Ce;for(var n in c)if(n!=="default"&&Object.prototype.hasOwnProperty.call(c,n)){var d=o?Ce(c,n):null;d&&(d.get||d.set)?Object.defineProperty(i,n,d):i[n]=c[n]}return i.default=c,e&&e.set(c,i),i}function Fe(c,p){var e=typeof ye<"u"&&xe(c)||c["@@iterator"];if(!e){if(Array.isArray(c)||(e=Ve(c))||p&&c&&typeof c.length=="number"){e&&(c=e);var i=0,o=function(){};return{s:o,n:function(){return i>=c.length?{done:!![]}:{done:![],value:c[i++]}},e:function(l){throw l},f:o}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var n=!![],d=![],r;return{s:function(){e=e.call(c)},n:function(){var l=e.next();return n=l.done,l},e:function(l){d=!![],r=l},f:function(){try{!n&&e.return!=null&&e.return()}finally{if(d)throw r}}}}function Ve(c,p){var e;if(c){if(typeof c=="string")return De(c,p);var i=ge(e=Object.prototype.toString.call(c)).call(e,8,-1);if(i==="Object"&&c.constructor&&(i=c.constructor.name),i==="Map"||i==="Set")return Ee(c);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return De(c,p)}}function De(c,p){(p==null||p>c.length)&&(p=c.length);for(var e=0,i=new Array(p);e<p;e++)i[e]=c[e];return i}var Le=new He.default,Ne=function(){function c(p,e){(0,se.default)(this,c),this.viewer=p,this.options=e||{},this.handler=void 0,this._isOnly=!![],this._enable=!![],this.pickOpen=![],this._depthTest=!![],this.viewerid=p._container.id,this.popupShow=!![],this.objPopup={},this._pickFeatureProperties=void 0,this._pickType=0,this.identifyTasks3d=[],this.highlighted={feature:void 0,originalColor:new t.Color},this.defaultHighlightedClrCss="#ff0000",this.getPopupForConfig=C.getPopupForConfig,this.getPopup=C.getPopup,this.currentEleId=void 0,this.result=void 0,this.subLayerResults=void 0,this.currentSubLayerResult=void 0;var i='<div id="'+this.viewerid+'pupup-all-view" ></div>',o='<div id="'+this.viewerid+'mypupup-all-view" ></div>';(0,R.default)("#"+this.viewerid).append(i),(0,R.default)("#"+this.viewerid).append(o),this.viewer.scene.postRender.addEventListener(this.bind2scene,this),this._identifyed=new t.Event,this._identifyedAll=new t.Event,this.pickedObjects={}}return(0,ve.default)(c,[{key:"identifyed",get:function(){return this._identifyed}},{key:"identifyedAll",get:function(){return this._identifyedAll}},{key:"activate",value:function(){var e=this;!this.handler&&(this.handler=new t.ScreenSpaceEventHandler(this.viewer.scene.canvas)),this.handler.setInputAction(function(i){var o=this,n,d;(0,E.default)(this,e);var r=P.getCurrentMousePosition(this.viewer.scene,i.position),u=(0,$.cartesian2lonlat)(r);if(this.viewer.maskGeoJson){var l=Le.writeGeometryObject(Le.readGeometry(this.viewer.maskGeoJson));if(!(0,H.booleanPointInPolygon)(u,l))return}this.pickedObjects={},document.getElementById(this.viewer._container.id).style.cursor="wait";var h=(0,A.v4)(),a=this.viewer.shine.getCheckedLayers(),s=this.viewer.shine.getDrawLayerInfos(),y=(0,X.default)(a).call(a,s),v=[];try{v=this.getPickedObjects(i)}catch(S){L.error(S)}var b=[],O=[];v.forEach(function(S){var Z,K,q,_,I,G,V;(0,E.default)(this,o);var M=(S==null||(Z=S.tileset)===null||Z===void 0?void 0:Z.id)||(S==null||(K=S.id)===null||K===void 0||(q=K.entityCollection)===null||q===void 0||(_=q.owner)===null||_===void 0?void 0:_.name)||(S==null||(I=S.content)===null||I===void 0||(G=I.tile)===null||G===void 0||(V=G.i3sNode)===null||V===void 0?void 0:V._dataProvider.layerID);M&&O.push(M)}.bind(this));for(var T=(0,re.default)(n=(0,Y.default)(d=(0,Y.default)(y).call(y,function(S){return(0,E.default)(this,o),S.serverOrigin=="3d_server"||S.type=="geoJson"||S.type=="geojson-draw"||S.type=="feature"||S.type=="feature-pbf"||S.type=="geoserver-wfs"}.bind(this))).call(d,function(S){return(0,E.default)(this,o),(0,Oe.default)(O).call(O,S.id)}.bind(this))).call(n,function(S,Z){var K=this;(0,E.default)(this,o);var q=(0,fe.default)(v).call(v,function(I){var G,V,M,ie,k,le,ne;(0,E.default)(this,K);var Re=(I==null||(G=I.tileset)===null||G===void 0?void 0:G.id)||(I==null||(V=I.id)===null||V===void 0||(M=V.entityCollection)===null||M===void 0||(ie=M.owner)===null||ie===void 0?void 0:ie.name)||(I==null||(k=I.content)===null||k===void 0||(le=k.tile)===null||le===void 0||(ne=le.i3sNode)===null||ne===void 0?void 0:ne._dataProvider.layerID);return Re===S.id}.bind(this)),_=(0,fe.default)(v).call(v,function(I){var G,V,M,ie,k,le,ne;(0,E.default)(this,K);var Re=(I==null||(G=I.tileset)===null||G===void 0?void 0:G.id)||(I==null||(V=I.id)===null||V===void 0||(M=V.entityCollection)===null||M===void 0||(ie=M.owner)===null||ie===void 0?void 0:ie.name)||(I==null||(k=I.content)===null||k===void 0||(le=k.tile)===null||le===void 0||(ne=le.i3sNode)===null||ne===void 0?void 0:ne._dataProvider.layerID);return Re===Z.id}.bind(this));return q-_}.bind(this)),D=0;D<T.length;D++){var B=(0,j.compatibleOldFormConfig)(T[D]),g=this.get3dServerIdentifyTask(B,v,i.position);g&&b.push(g)}for(var ae=0,be=y.length;ae<be;ae++){var z=(0,j.compatibleOldFormConfig)(y[ae]);if(z.serverOrigin=="arcgis"&&z.type!="feature"&&z.type!="feature-pbf"){var de=this.getArcgisIdentifyparams(z.id,r),ke=de.rectangle,Te=de.tileWidth,Ie=de.tileHeight,ce=this.getEarthResolution(r),ue=(0,j.getArcgisIdentifyTask)(z,u,{viewer:this.viewer},{cartesian:r,rectangle:ke,tileWidth:Te,tileHeight:Ie,earthResolution:ce});ue&&b.push(ue)}else if(z.serverOrigin=="geoserver"&&z.type!="geoserver-wfs"){var he=this.getEarthResolution(r),oe=(0,j.getGeoServerIdentifyTask)(z,u,{viewer:this.viewer},{cartesian:r,earthResolution:he});oe&&b.push(oe)}}b.length>0?this.taskHandle(b,h,u):(document.getElementById(this.viewer._container.id).style.cursor="auto",this._identifyed.raiseEvent([],u,h),this._identifyedAll.raiseEvent([],u,h))}.bind(this),t.defaultValue(this.options.popupEventType,t.ScreenSpaceEventType.LEFT_CLICK))}},{key:"getPickedObjects",value:function(e){var i=this,o=this.viewer.scene.drillPick(e.position),n=this.normalRayPick(e),d;function r(a){if(a.primitive instanceof t.GroundPrimitive)return a}function u(a){if(a instanceof t.Cesium3DTileFeature)return a}function l(a){if(!(a.primitive instanceof t.GroundPrimitive))return a}if(o.some(r)||n.some(r)){var h=(0,Y.default)(n).call(n,r);d=(0,Y.default)(o).call(o,l),h.forEach(function(a){var s,y;(0,E.default)(this,i);var v=(s=a.id)===null||s===void 0||(y=s.attribute)===null||y===void 0?void 0:y.classificationType;v==2&&o.some(u)?d.unshift(a):v==0?d.push(a):v==1&&o.some(u)?d.unshift(a):d.push(a)}.bind(this))}else d=o;return d}},{key:"normalRayPick",value:function(e){for(var i=P.getCurrentMousePosition(this.viewer.scene,e.position),o=new t.Cartesian3(0,0,0),n=(0,P.addPositionsHeight)(i,.2),d=new t.Cartesian3,r=t.Cartesian3.normalize(t.Cartesian3.subtract(o,i,d),d),u=new t.Ray(n,r),l,h=[],a=this.viewer.scene.drillPickFromRay(u,null,null,1e-9),s=0,y=a.length;s<y;s++){var v=a[s];v.object!==void 0&&(l=v.object,l.position1=v.position,l.position2=(0,$.cartesian2lonlat)(v.position),h.push(l))}return h}},{key:"taskHandle",value:function(e,i,o){var n=this,d=0,r=[],u=Fe(e),l;try{var h=function(){var s=this,y=l.value;y.id=i,y.then(function(v){(0,E.default)(this,s),document.getElementById(n.viewer._container.id).style.cursor="auto",d++,y.id===i&&(n._identifyed.raiseEvent(v,o,i),v.results.length&&r.push(v),d===e.length&&n._identifyedAll.raiseEvent(r,o,i))}.bind(this)).catch(function(v){(0,E.default)(this,s),d++,d===e.length&&n._identifyedAll.raiseEvent(r,o,i),document.getElementById(n.viewer._container.id).style.cursor="auto",L.error(v)}.bind(this))};for(u.s();!(l=u.n()).done;)h()}catch(a){u.e(a)}finally{u.f()}}},{key:"get3dServerIdentifyTask",value:function(e,i,o){var n,d=this,r=e==null||(n=e.identifyField)===null||n===void 0?void 0:(0,Y.default)(n).call(n,function(l){return(0,E.default)(this,d),l.isOpenSearch!==![]}.bind(this));if(e.group==="2"&&r?.length>0&&(0,j.judgeZoomLimit)({viewer:this.viewer},e.identifyZoom)||e.type==="geojson-draw"){var u=[];return i.forEach(function(l){var h,a,s,y,v,b,O;(0,E.default)(this,d);var T=(l==null||(h=l.tileset)===null||h===void 0?void 0:h.id)||(l==null||(a=l.id)===null||a===void 0||(s=a.entityCollection)===null||s===void 0||(y=s.owner)===null||y===void 0?void 0:y.name)||(l==null||(v=l.content)===null||v===void 0||(b=v.tile)===null||b===void 0||(O=b.i3sNode)===null||O===void 0?void 0:O._dataProvider.layerID);T===e.id&&u.push(l)}.bind(this)),new Ae.default(function(l){var h=this;(0,E.default)(this,d),this.get3dServerFeature(e,u,r,o).then(function(a){var s=this;(0,E.default)(this,h),a.forEach(function(v){var b=this;if((0,E.default)(this,s),v.layerInfo={id:e.id,serverOrigin:e.serverOrigin,type:e.type},e.serverOrigin==="arcgis"){var O=v.attributes,T=v.identifyField,D={},B=T.fieldAliases;(0,pe.default)(O).forEach(function(g){(0,E.default)(this,b),D[B[g]]=O[g]}.bind(this)),v.attributes=D}}.bind(this));var y={type:e.serverOrigin,layerLabel:e.label,layerId:e.id,isPop:e.isPop,layerTag:e.layerTag,results:a};l(y)}.bind(this))}.bind(this))}}},{key:"get3dServerFeature",value:function(){var p=(0,we.default)(te.default.mark(function i(o,n,d,r){var u,l,h,a,s,y,v,b,O,T,D;return te.default.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:!d&&(d=[{temp:!![],popup3d:"all",pickfeaturestyle:{color:this.defaultHighlightedClrCss,outlineColor:"#37B842"}}]),u=[],l=0;case 3:if(!(l<d.length)){g.next=37;break}if(this.currentSubLayerResult=[],h=[],a=d[l],g.prev=7,a.drillPick!=!![]){g.next=22;break}s=0;case 10:if(!(s<n.length)){g.next=20;break}if(v=n[s],(v==null||(y=v.tileset)===null||y===void 0?void 0:y.label)!=a.name){g.next=17;break}return g.next=15,this.pick3dObjectFeatures(r,v,o,a);case 15:b=g.sent,h.push(b);case 17:s++,g.next=10;break;case 20:g.next=28;break;case 22:return T=void 0,(O=o.symbol)!==null&&O!==void 0&&O.volumeStyle,T=n[0],g.next=26,this.pick3dObjectFeatures(r,T,o,a);case 26:D=g.sent,h.push(D);case 28:g.next=33;break;case 30:g.prev=30,g.t0=g.catch(7),L.error(g.t0);case 33:u=(0,X.default)(u).call(u,h);case 34:l++,g.next=3;break;case 37:return g.abrupt("return",u);case 38:case"end":return g.stop()}},i,this,[[7,30]])}));function e(i,o,n,d){return p.apply(this,arguments)}return e}()},{key:"pick3dObjectFeatures",value:function(){var p=(0,we.default)(te.default.mark(function i(o,n,d,r){var u=this,l,h,a,s,y,v,b,O,T,D,B,g,ae,be,z,de,ke,Te,Ie,ce,ue,he,oe,S,Z,K,q,_,I,G,V,M;return te.default.wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(!(t.defined(n)&&t.defined(n.id)&&n.id instanceof t.Entity)){k.next=14;break}return l=n.id,h=l.geojsondata,n._pickType=1,(l.billboard||l.label||l.point||l.model)&&!l.polygon&&!l.polyline?(a=l.position,s=l.label||l.billboard||l.point||l.model,s&&s.heightReference?(a=this.getPositionValue(a),s.heightReference._value===t.HeightReference.CLAMP_TO_GROUND?a=P.updateHeightForClampToGround(this.viewer,a):s.heightReference._value===t.HeightReference.RELATIVE_TO_GROUND&&(a=P.updateHeightForClampToGround(this.viewer,a,!![]))):a=this.getPositionValue(a)):(a=P.getCurrentMousePosition(this.viewer.scene,o),a=this.getPositionValue(a)),!a&&(a=(0,m.getCenterPosition)(l)),r.temp?y=n.id.attribute.attr:y=C.getAttrVal(l.properties),v=(0,A.v4)(),this.pickedObjects[v]=n,b={attributes:y,identifyField:r,pickedObject:v,cartesian:a,position:(0,$.cartesian2lonlat)(a),geometry:(0,me.default)(h)},r.temp&&(O=n.id.attribute,O.drawtype==="videoProjection"&&(T=O.style,D=T.viewPosition,B=T.showFrustumOutline,g=T.showPlayer,ae=T.showSketch,be=T.verticalViewAngle,z=T.videoUrl,de=T.viewDistance,ke=T.viewHeading,Te=T.viewPitch,Ie=T.horizontalViewAngle,b.video={viewPosition:D,showFrustumOutline:B,showPlayer:g,showSketch:ae,verticalViewAngle:be,videoUrl:z,viewDistance:de,viewHeading:ke,viewPitch:Te,horizontalViewAngle:Ie})),k.abrupt("return",b);case 14:if(!(t.defined(n)&&t.defined(n.tileset)&&t.defined(n.getProperty))){k.next=40;break}n._pickType=2,ce={},ue=n.getPropertyIds(),he=0;case 19:if(!(he<ue.length)){k.next=30;break}if(oe=ue[he],n.hasProperty(oe)){k.next=23;break}return k.abrupt("continue",27);case 23:if(S=n.getProperty(oe),S!=null){k.next=26;break}return k.abrupt("continue",27);case 26:ce[oe]=S;case 27:he++,k.next=19;break;case 30:if(Z=n.tileset._config,!Z){k.next=38;break}if(Z.popup=r.popup3d,!t.defined(Z.popup)){k.next=38;break}return K=P.getCurrentMousePosition(this.viewer.scene,o),q=(0,A.v4)(),this.pickedObjects[q]=n,k.abrupt("return",{attributes:ce,identifyField:r,cartesian:K,pickedObject:q,position:(0,$.cartesian2lonlat)(K)});case 38:k.next=51;break;case 40:if(!(t.defined(n.content)&&t.defined(n.content.tile.i3sNode))){k.next=51;break}if(_=n.content.tile.i3sNode,n._pickType=4,I=P.getCurrentMousePosition(this.viewer.scene,o),G=this.viewer.scene.pickPosition(o),!G){k.next=51;break}return k.next=48,_.loadFields().then(function(){return(0,E.default)(this,u),V=_.getFieldsForPickedPosition(G),V}.bind(this));case 48:return M=(0,A.v4)(),this.pickedObjects[M]=n,k.abrupt("return",{attributes:V,identifyField:r,cartesian:I,pickedObject:M,position:(0,$.cartesian2lonlat)(I)});case 51:case"end":return k.stop()}},i,this)}));function e(i,o,n,d){return p.apply(this,arguments)}return e}()},{key:"getEarthResolution",value:function(e){var i=.1;try{var o=this.viewer,n=(0,$.cartesian2Carto)(e),d=(0,$.lonlat2cartesian)([t.Math.toDegrees(n.longitude),t.Math.toDegrees(n.latitude),0]),r=t.SceneTransforms.wgs84ToWindowCoordinates(o.scene,d),u=o.scene.camera.getPickRay(new t.Cartesian2(r.x,r.y)),l=o.scene.camera.getPickRay(new t.Cartesian2(r.x+1,r.y)),h=o.scene.globe,a=h.pick(u,o.scene),s=h.pick(l,o.scene),y=h.ellipsoid.cartesianToCartographic(a),v=h.ellipsoid.cartesianToCartographic(s),b=new t.EllipsoidGeodesic;b.setEndPoints(y,v),i=b.surfaceDistance}catch(O){L.error(O)}return i}},{key:"getArcgisIdentifyparams",value:function(e,i){for(var o=(0,$.cartesian2Carto)(i),n=this.viewer.scene.globe._surface._tilesToRender,d=t.Rectangle.fromCartesianArray([i]),r=0;r<n.length;r++)if(t.Rectangle.contains(n[r]._rectangle,o)){d=n[r]._rectangle;break}var u={west:t.Math.toDegrees(d.west),south:t.Math.toDegrees(d.south),east:t.Math.toDegrees(d.east),north:t.Math.toDegrees(d.north)},l=this.viewer.shine.getLayer(e,"id").layer.imageryProvider;return{rectangle:u,tileWidth:l.tileWidth,tileHeight:l.tileHeight}}},{key:"removeFeature",value:function(){this.lastShowFeature!=null&&(this.viewer.dataSources.remove(this.lastShowFeature),this.lastShowFeature=null)}},{key:"showFeature",value:function(e,i){var o=this;this.removeFeature();var n=e;if(e.geometryType&&e.geometryType.indexOf("esri")!==-1)if((0,me.default)(e.geometry).length<2e5)if(Q.esri)n=Q.esri.Util.arcgisToGeoJSON(e.geometry);else{L.warn("\u9700\u8981\u5F15\u5165 mars-esri \u63D2\u4EF6\u89E3\u6790arcgis\u6807\u51C6\u7684json\u6570\u636E\uFF01");return}else{L.warn("\u77E2\u91CF\u9762\u8303\u56F4\u548C\u9876\u70B9\u8FC7\u591A\uFF0C\u4E0D\u663E\u793A\uFF01");return}else if(e.geometry&&e.geometry.type&&Q){var d=Q.geoJSON(e.geometry,{coordsToLatLng:function(h){return h[0]>180||h[0]<-180?Q.CRS.EPSG3857.unproject(Q.point(h[0],h[1])):new Q.LatLng(h[1],h[0],h[2])}});n=d.toGeoJSON()}if(n!=null){var r={};i.strokeWidth?r=i:(r.strokeWidth=i.outlineWidth,r.fillAlpha=i.opacity/100,r.fill=i.color,r.stroke=i.outlineColor);var u=t.GeoJsonDataSource.load(n,{clampToGround:!![],stroke:new t.Color.fromCssColorString(r.stroke||this.defaultHighlightedClrCss),strokeWidth:r.strokeWidth||3,fill:new t.Color.fromCssColorString((0,W.default)(r)||this.defaultHighlightedClrCss).withAlpha(r.fillAlpha||.7)});u.then(function(l){var h=this,a=(0,je.default)(l.entities);r.strokeWidth>1&&a.forEach(function(s){(0,E.default)(this,h),s.polygon.outline=![];var y={color:r.stroke,width:r.strokeWidth,opacity:i.opacity,lineType:"solid",clampToGround:!![],classificationType:t.ClassificationType.BOTH,outline:![]},v=x.style2Entity(y);v.positions=w.getPositions(s),s.polyline=v}.bind(this)),o.viewer.dataSources.add(l),o.lastShowFeature=l,t.defined(i.showTime)&&setTimeout(function(){o.removeFeature()},i.showTime)}).catch(function(l){L.error(l)})}}},{key:"unHighlighPick",value:function(){if(t.defined(this.highlighted.feature)){var e=this.highlighted.feature.id;try{this.highlighted.feature._pickType===2?this.highlighted.feature.color=this.highlighted.originalColor:this.highlighted.feature._pickType===4?this.highlighted.feature.color=this.highlighted.originalColor:e.polygon?this.highlighted.feature.id.polygon.material=this.highlighted.originalColor:e.wall?this.highlighted.feature.id.wall.material=this.highlighted.originalColor:e.ellipse?this.highlighted.feature.id.ellipse.material=this.highlighted.originalColor:e.rectangle?this.highlighted.feature.id.rectangle.material=this.highlighted.originalColor:e.ellipsoid?this.highlighted.feature.id.ellipsoid.material=this.highlighted.originalColor:e.polyline?this.highlighted.feature.id.polyline.material=this.highlighted.originalColor:e.label?this.highlighted.feature.id.label.fillColor?this.highlighted.feature.id.label.fillColor._value=this.highlighted.originalColor:this.highlighted.feature.id.label.fillColor=this.highlighted.originalColor:e.billboard?this.highlighted.feature.id.billboard.color._value=this.highlighted.originalColor:e.point?this.highlighted.feature.id.point.color._value=this.highlighted.originalColor:e.model&&(this.highlighted.feature.id.model.color._value=this.highlighted.originalColor)}catch(i){L.error(i)}this.highlighted.feature=void 0}}},{key:"highlighPick",value:function(e,i){var o,n,d,r,u;this.unHighlighPick();var l=e?.pickedObject,h=e==null||(o=e.identifyField)===null||o===void 0||(n=o.pickfeaturestyle)===null||n===void 0?void 0:n.color,a=((d=e==null||(r=e.identifyField)===null||r===void 0||(u=r.pickfeaturestyle)===null||u===void 0?void 0:u.opacity)!==null&&d!==void 0?d:100)/100,s=l.id,y;if(s){var v,b,O,T,D,B=s.rectangle||s.wall||s.ellipse||s.ellipsoid||s.polygon||s.polyline||s.label||s.billboard||(s==null||(v=s.label)===null||v===void 0?void 0:v.isTrueGraphic)&&s.label||(s==null||(b=s.billboard)===null||b===void 0?void 0:b.isTrueGraphic)&&s.billboard||(s==null||(O=s.point)===null||O===void 0?void 0:O.isTrueGraphic)&&s.point||(s==null||(T=s.model)===null||T===void 0?void 0:T.isTrueGraphic)&&s.model;y=(B==null||(D=B.material)===null||D===void 0?void 0:D.color)||B.fillColor||B.color}if(l)l._pickType==1?(this.highlighted.feature=l,t.Color.clone(y._value,this.highlighted.originalColor),h&&typeof h=="string"&&(s.rectangle?l.id.rectangle.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.wall?l.id.wall.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.ellipse?l.id.ellipse.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.ellipsoid?l.id.ellipsoid.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.polygon?l.id.polygon.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.polyline?l.id.polyline.material=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.label?l.id.label.fillColor=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.billboard?l.id.billboard.color=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.point?l.id.point.color=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):s.model&&(l.id.model.color=new t.Color.fromCssColorString(h).withAlpha(a)||new t.Color.fromCssColorString(this.defaultHighlightedClrCss)))):l._pickType==2?(this.highlighted.feature=l,t.Color.clone(l.color,this.highlighted.originalColor),l.color=new t.Color.fromCssColorString(h).withAlpha(a)):l._pickType==4&&(this.highlighted.feature=l.content.tile.i3sNode.tile,this.highlighted.feature._pickType=4,l.content.tile.color=new t.Color.fromCssColorString(h).withAlpha(a));else if(this.highlighted.feature=e,t.Color.clone(e.color,this.highlighted.originalColor),i){var g={};g.strokeWidth=i.outlineWidth,g.fillAlpha=i.opacity/100,g.fill=i.color,g.stroke=i.outlineColor,e.id.polygon?e.id.polygon.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.rectangle?e.id.rectangle.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.wall?e.id.wall.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.ellipse?e.id.ellipse.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.ellipsoid?e.id.ellipsoid.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.polyline?e.id.polyline.material=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.label?e.id.label.fillColor=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.billboard?e.id.billboard.color=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.point?e.id.point.color=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss):e.id.model&&(e.id.model.color=new t.Color.fromCssColorString((0,W.default)(g))||new t.Color.fromCssColorString(this.defaultHighlightedClrCss))}}},{key:"show",value:function(e,i,o){if(!(e==null||e.popup==null)){!i&&(i=(0,m.getCenterPosition)(e));var n=e.billboard||e.label||e.point||e.model;n&&n.heightReference&&(i=this.getPositionValue(i),n.heightReference._value===t.HeightReference.CLAMP_TO_GROUND?i=P.updateHeightForClampToGround(this.viewer,i):n.heightReference._value===t.HeightReference.RELATIVE_TO_GROUND&&(i=P.updateHeightForClampToGround(this.viewer,i,!![])));var d=this.getPopupId(e);this.close(d),this.objPopup[d]={id:e.id,popup:e.popup,entity:e,cartesian:i,viewPoint:o};var r;if((0,J.default)(e.popup)==="object"?r=e.popup.html:r=e.popup,!!r){var u=this;typeof r=="function"&&(r=r(e,i,function(l){u._showHtml(l,d,e,i,o)})),r&&this._showHtml(r,d,e,i,o)}}}},{key:"showQuery",value:function(e,i,o,n){if(!(e==null||e.popup==null)){!i&&(i=(0,m.getCenterPosition)(e));var d=e.billboard||e.label||e.point||e.model;d&&d.heightReference&&(i=this.getPositionValue(i),d.heightReference._value===t.HeightReference.CLAMP_TO_GROUND?i=P.updateHeightForClampToGround(this.viewer,i):d.heightReference._value===t.HeightReference.RELATIVE_TO_GROUND&&(i=P.updateHeightForClampToGround(this.viewer,i,!![])));var r="myTestPopup";this.objPopup&&(this.objPopup[r]={id:e.id,popup:e.popup,entity:e,cartesian:i,viewPoint:o});var u;(0,J.default)(e.popup)==="object"?u=e.popup.html:u=e.popup,u&&(typeof u=="function"&&(u=u(e,i,function(){})),u&&n.isPop&&n.isPop==!![]&&this._showHtmlQuery(u,r,e,i,o))}}},{key:"_showHtml",value:function(e,i,o,n,d){(0,R.default)("#"+this.viewerid+"pupup-all-view").append('<div id="'+i+'" class="cesium-popup">            <a id="'+i+'-popup-close" data-id="'+i+'" class="cesium-popup-close-button cesium-popup-color" >\xD7</a>            <div class="cesium-popup-content-wrapper cesium-popup-background">                <div class="cesium-popup-content cesium-popup-color">'+e+'</div>            </div>            <div class="cesium-popup-tip-container"><div class="cesium-popup-tip cesium-popup-background"></div></div>        </div>');var r=this;(0,R.default)("#"+i+"-popup-close").click(function(){var l=(0,R.default)(this).attr("data-id");r.close(l,!![]);try{o.entityCollection.remove(o)}catch{L.error("")}});var u=this.updateViewPoint(i,n,o.popup,d);!u&&this._depthTest&&this.close(i)}},{key:"_showHtmlQuery",value:function(e,i,o,n,d){var r=document.getElementById(i);if(r)(0,R.default)("#"+i).show();else{var u,l;(0,R.default)("#"+this.viewerid+"mypupup-all-view").append((0,X.default)(u=(0,X.default)(l='<div id="'.concat(i,'" class="cesium-popup"><a id="')).call(l,i,'-popup-close" data-id="')).call(u,i,'" style="position: absolute;top: 22px;right: 6px;font-size: 17px;color: #e2e2e2;z-index: 9999"><i class="el-icon-close"></i></a><div class="cesium-popup-tip-container"></div></div>'));var h=this;(0,R.default)("#"+i+"-popup-close").click(function(){var s=(0,R.default)(this).attr("data-id");h.closeQuery(s,!![]),o&&o.entityCollection&&o.entityCollection.remove(o)})}var a=this.updateViewPoint(i,n,o.popup,d);!a&&this._depthTest&&this.closeQuery(i)}},{key:"getPositionValue",value:function(e){if(!e)return e;var i;return e instanceof t.Cartesian3?i=e:typeof e.getValue=="function"?i=e.getValue(this.viewer.clock.currentTime):e._value&&e._value instanceof t.Cartesian3&&(i=e._value),i}},{key:"getPickType",value:function(){return this._pickType?this._pickType:this._pickType}},{key:"getPickFeaturePropertiese",value:function(){if(this._pickFeatureProperties)return this._pickFeatureProperties}},{key:"updateViewPoint",value:function(e,i,o,n){var d=this.getPositionValue(i);if(!t.defined(d))return![];var r=t.SceneTransforms.wgs84ToWindowCoordinates(this.viewer.scene,d);if(t.defined(r)&&(n=r,this.objPopup[e]&&(this.objPopup[e].viewPoint=r)),!t.defined(n))return L.warn("wgs84ToWindowCoordinates\u65E0\u6CD5\u8F6C\u6362\u4E3A\u5C4F\u5E55\u5750\u6807"),![];var u=this.viewer.scene;if(this._depthTest&&u.mode===t.SceneMode.SCENE3D){var l=u.camera.getPickRay(n),h=u.globe.pick(l,u);if(h){var a=t.Cartesian3.distance(d,h);if(a>1e3*1e3)return![]}}if((typeof o>"u"?"undefined":(0,J.default)(o))==="object"&&o.timeRender&&o.html&&typeof o.html=="function"){var s=o.html(this.objPopup[e]&&this.objPopup[e].entity,d);(0,R.default)("#"+e+" .cesium-popup-content").html(s)}var y=(0,R.default)("#"+e),v=n.x-y.width()/2,b=n.y-y.height();return o&&(typeof o>"u"?"undefined":(0,J.default)(o))==="object"&&o.anchor&&(v+=o.anchor[0],b+=o.anchor[1]),y.css("transform","translate3d("+v+"px,"+b+"px, 0)"),!![]}},{key:"bind2scene",value:function(){for(var e in this.objPopup)if(this.objPopup.hasOwnProperty(e)){var i=this.objPopup[e],o=i.entity instanceof t.Entity;if(o&&!i.entity.entityCollection.contains(i.entity)){i.entity=null,this.closeQuery(e);continue}var n=this.updateViewPoint(e,i.cartesian,i.popup,i.viewPoint);!n&&this._depthTest&&this.closeQuery(e)}}},{key:"getPopupId",value:function(e){return this.viewerid+"popup_"+((e.id||"")+"").replace(new RegExp("[^0-9a-zA-Z_]","gm"),"_")}},{key:"close",value:function(e,i){if(!this._isOnly&&e){(typeof e>"u"?"undefined":(0,J.default)(e))==="object"&&(e=this.getPopupId(e));for(var o in this.objPopup)if(this.objPopup.hasOwnProperty(o)&&(e===this.objPopup[o].id||e===o)){(0,R.default)("#"+o).remove(),delete this.objPopup[o];break}}else(0,R.default)("#"+this.viewerid+"pupup-all-view").empty(),this.objPopup={};i&&(this.removeFeature(),this.unHighlighPick())}},{key:"closeQuery",value:function(e,i){if(!this._isOnly&&e){(typeof e>"u"?"undefined":(0,J.default)(e))==="object"&&(e=this.getPopupId(e));for(var o in this.objPopup)if(this.objPopup.hasOwnProperty(o)&&(e===this.objPopup[o].id||e===o)){(0,R.default)("#"+o).remove(),delete this.objPopup[o];break}}else e?(0,R.default)("#"+e).hide():((0,R.default)("#"+this.viewerid+"pupup-all-view").empty(),this.objPopup={});i&&(this.removeFeature(),this.unHighlighPick())}},{key:"destroy",value:function(){this.close(),this.viewer.scene.postRender.removeEventListener(this.bind2scene,this),this.handler.destroy(),this.handler=null,(0,R.default)("#"+this.viewerid+"pupup-all-view").remove()}},{key:"isOnly",get:function(){return this._isOnly},set:function(e){this._isOnly=e}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,!e&&this.close()}},{key:"depthTest",get:function(){return this._depthTest},set:function(e){this._depthTest=e}}]),c}();U.Popup=Ne}}]);
