"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[434],{8406:function(S,r,i){i.r(r),i.d(r,{setting:function(){return u}});const u={isGeojson:!0,geojson:i(30512),layerUrl:"http://192.168.11.48:8080/geoserver/pg/ows",layerType:"geo-wfs",layerName:"pg:zj_xzqh",opacity:.8,blur:15}},68042:function(S,r,i){i.d(r,{$:function(){return w}});var u=i(27966),v=i(49500);function w(m,l,y,I){let p=l[y];p&&p.length<1||p.forEach(n=>{if(n&&n.length<1)return;let c=n[0][1]+"_"+n[0][0];n[0][1].indexOf("_")>-1&&(c=n[0][1]),u.Z.$on(c,d=>{v.debug("gis\u7EC4\u4EF6\u63A5\u6536\u4E8B\u4EF6\u89E6\u53D1");let h=n[0][2];if(h){let f=h.indexOf("|");f>-1&&(h=n[0][2].substring(f+1))}l.script&&l.script.enabled?(m._doAction=new Function("data","param_key","value","info",l.script.content),m._doAction(d,h,l.value,d)):I(d[h],d)})})}},30434:function(S,r,i){i.r(r),i.d(r,{default:function(){return C}});var u=function(){var t=this,e=t._self._c;return e("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"gis-theme-heatmap",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"},attrs:{map:t.map}},[e("hide-button",{attrs:{attr:t.widgetInfo.attr}})],1)},v=[],w=i(44513),m=i(45061),l=i(26711),y=i(37564),I=i(31751),p=i(53183),n=i.n(p),c=i(2487),d=i(56828),h=i(49500);class f{constructor(t,e){this.map=t,this.callback=e,this.geoJSON=new y.default,this.esrijsonFormat=new I.Z,this.mapId=this.map.getTarget().id}initHeatMap(t){if(t)this.options=t;else{let e=i(8406);this.options=e.setting}this.clear(),this.options.isGeojson?this._geoJson(this.options.geojson):this.options.layerUrl&&this._loadVecLayer()}_geoJson(t,e){t instanceof Object||(t=JSON.parse(t));let s=(t.wkid?t.wkid:e)+"";s.indexOf("EPSG:")===-1&&(s="EPSG:"+s);let o=null;this.options.isGeojson?o=new c.default({features:this.geoJSON.readFeatures(t,{dataProjection:s,featureProjection:this.map.getView().getProjection().getCode()})}):o=new c.default({features:t});let g=new d.Z({id:"HeatMap",zIndex:9999,source:o,opacity:this.options.opacity?this.options.opacity:.8,blur:this.options.blur?this.options.blur:15,radius:this.options.radius?this.options.radius:8,shadow:this.options.shadow?this.options.shadow:250,renderMode:"image"});this.map.addLayer(g),this.vec=g}_loadVecLayer(){this.options.layerType==="geo-wfs"?this.loadGeoserverWFS():this.options.layerType==="arc-vector"?this.loadArcgisVector():h.log("\u6682\u4E0D\u652F\u6301\u5176\u4ED6\u670D\u52A1\u7C7B\u578B")}loadGeoserverWFS(){var t=this.options.layerUrl,e={service:"WFS",version:"1.1.0",request:"GetFeature",typeName:this.options.layerName,outputFormat:"application/json",maxFeatures:1e5,srsName:this.map.getView().getProjection().getCode(),CQL_FILTER:this.options.where?this.options.where:"1=1"};this._Ajax(t,e,s=>{let o=this.geoJSON.readFeatures(s);this._geoJson(o,this.map.getView().getProjection().getCode())})}loadArcgisVector(){let t=this.map.getView().getProjection().getCode().split(":")[1],e=this.options.layerUrl+"/"+this.options.initLayer+"/query",s={f:"json",outSR:t,outFields:"*",where:this.options.where?this.options.where:"1=1"};this._Ajax(e,s,o=>{h.log(o);let g=this.esrijsonFormat.readFeatures(o);this._geoJson(g,t)})}setRadius(t){this.vec.setRadius(t)}setBlur(t){this.vec.setBlur(t)}clear(){let t=this.map.getLayers().getArray(),e=[];t.forEach(s=>{s.values_.id==="HeatMap"&&e.push(s)}),e.forEach(s=>{this.map.removeLayer(s)})}_Ajax(t,e,s){n().ajax({url:t,type:"POST",dataType:"json",data:e,success:o=>{s(o)},error:o=>{h.log(o)}})}}var H=i(86892),M=i(41739),A=i(42709),O=i(83574),N=i(68042);let L=.001373291015625,F=7,P=14;var j=L*F,x=L*P,R={name:"GisThemeHeatmap",components:{HideButton:w.Z},mixins:[H.D,m.u,l.H,A.Z,O.default],props:["widgetInfo"],data(){return this.heatmap,{xzqdm:null,zoomwatch:!1,actionName:null,actionParam:null,isPostMessage:null}},beforeDestroy(){this.heatmap&&this.heatmap.clear()},mounted(){this.loadInfo(this.widgetInfo),this.initHeatMap(),this.initAction(this.widgetInfo)},methods:{loadInfo(a){let t=this;M.default.$on("mapSearch",e=>{t.zoomwatch=!e})},reLoadInfo(a){this.loadInfo(a),this.initHeatMap()},initAction(a){this.actionSendout(a),this.actionReceive(a)},actionReceive(a){if(a.action===void 0||a.action.receive===void 0)return;let t=a.action.receive.executeAction;t&&t.enabled&&t.executeList&&t.executeList.length>0&&(0,N.$)(this,t,"executeList",this.rebuildHeatMap);let e=a.action.receive.show;e&&e.enabled&&e.showList&&e.showList.length>0&&this.doActionShowOrHide(e.showList,e.value,e.script,a.name,"show",!1);let s=a.action.receive.hide;s&&s.enabled&&s.hideList&&s.hideList.length>0&&this.doActionShowOrHide(s.hideList,s.value,s.script,a.name,"hide",!0)},rebuildHeatMap(a,t){let e={...JSON.parse(JSON.stringify(this.widgetInfo.config)),...t};this.heatmap.initHeatMap(e)},initHeatMap(){this.$map&&!this.heatmap&&(this.heatmap=new f(this.$map)),this.heatmap.initHeatMap(this.widgetInfo.config),this.widgetInfo.config.isKhAna&&(this.zz||(this.zz=this.$map.getView().on("change:resolution",()=>{this.$map.once("moveend",()=>{let a=this.$map.getView().getResolution(),t=parseInt(j/a),e=parseInt(x/a);this.heatmap.vec&&(this.heatmap.setRadius(t),this.heatmap.setBlur(e))})})))},onZoom(a,t,e){this.zoomwatch=!0,this.actionName=a,this.actionParam=t,this.isPostMessage=e},doConfigMap(a,t){if(this.widgetInfo.config.isKhAna){this.data=t;var e=this.map.map.getView().getResolution();let s=parseInt(j/e),o=parseInt(x/e);this.data.radius=s,this.data.blur=o,this.data.shadow=1800,this.heatmap.initHeatMap(this.data)}},doShow(){this.initHeatMap()},doHide(){this.heatmap&&this.heatmap.clear()}}},V=R,J=i(68141),z=(0,J.Z)(V,u,v,!1,null,"4940fde3",null),C=z.exports}}]);
