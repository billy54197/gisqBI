"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[6605],{52780:function(S,x,n){n.r(x),n.d(x,{setting:function(){return L}});const L={selectOption:{isShowXzq:!0,isShowCharts:!1,isShowRampLegend:!0,chartType:"ring",isDrill:!0,drillFromMouse:!1},xzqOption:{isGeoJson:!1,geojson:null,xzqdm_field:"xzqdm",xzqmc_field:"xzqmc",initXZQ:33,isShowXzqName:!0,isRamp:!0,rampOption:{borderColor:"rgba(5, 121, 138, 0.8)",fillColor:"rgba(5, 121, 138, 0.4)",isRampFill:!0,valueRange:["0~200","200~500","500~1000","1000~1500","1500~2500","2500~50000"],rampColor:["#8A2BE2","#FF8C00"]}},legendConfig:{isShow:!0,hideTitle:!1,style:"bottom:80px;right:20px;",opacity:.8},rampData:{3301:434,3302:734,3303:2256,3304:1446,3305:7896,3306:3256,3307:1768,3308:1278,3309:3457,3310:978,3311:184},chartOption:{isShowChartLegend:!0,legend:[{name:"\u519C\u7528\u5730",color:"#ff7f50"},{name:"\u5EFA\u8BBE\u7528\u5730",color:"#87cefa"},{name:"\u672A\u5229\u7528\u5730",color:"#da70d6"}],data:{3301:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3302:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3303:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3304:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3305:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3306:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3307:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3308:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3309:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3310:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}],3311:[{value:2e3,name:"\u519C\u7528\u5730"},{value:800,name:"\u5EFA\u8BBE\u7528\u5730"},{value:1200,name:"\u672A\u5229\u7528\u5730"}]}}}},96605:function(S,x,n){n.r(x),n.d(x,{default:function(){return vt}});var L=function(){var t=this,i=t._self._c;return i("div",{directives:[{name:"show",rawName:"v-show",value:t.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"gis-theme-cluster",style:{width:t.widgetInfo.attr.w+"px",height:t.widgetInfo.attr.hh+"px"}},[i("hide-button",{attrs:{attr:t.widgetInfo.attr}})],1)},F=[],N=n(44513),b=n(27966),R=n(45061),j=n(26711),D=n(43156),w=n(19065),M=n(75029),Z=n(53183),d=n.n(Z),B=n(9602),G=n.n(B),J=n(13811),X=n(31751),$=n(37564),H=n(7522),V=n(44727),Q=n(72449),q=n(68433),U=n(90583),k=n(2487),P=n(68640),K=n(23230),Y=n(82571),W=n(95659),_=n(62735),tt=n(35776),E=n.n(tt),et=n(7715),it=n.n(et),st=n(34752),at=n(49500);class T{constructor(t){(0,st.Z)(this,"colorHex",function(i){let e=i,a=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;if(/^(rgb|RGB)/.test(e)){let s=e.replace(/(?:(|)|rgb|RGB)*/g,"").split(","),l="#";for(let o=0;o<s.length;o++){let r=Number(s[o]).toString(16);r=r<10?"0"+r:r,r==="0"&&(r+=r),l+=r}return l.length!==7&&(l=e),l}else if(a.test(e)){let s=e.replace(/#/,"").split("");if(s.length===6)return e;if(s.length===3){let l="#";for(let o=0;o<s.length;o+=1)l+=s[o]+s[o];return l}}else return e}),this.map=t,this.mapId=this.map.getTarget().id}valueRangeColor(t,i,e){if(this.colorArr=[],this.valueRange=t,this.rampColor=i,e){let a=t.length,s=i[0],l=i[1];this.colorArr=this.gradientColor(s,l,a)}else this.colorArr=i;return this.getLegendColorObj()}getLegendColorObj(){let t={};return this.valueRange.forEach((i,e)=>{t[i]=this.colorArr[e]}),t}getColor(t){let i=-1;t=t||0,this.valueRange.forEach((a,s)=>{let l=[];if(a.indexOf("~")!==-1?l=a.split("~"):a.indexOf("-")!==-1&&(l=a.split("-")),l.length>0){let o=Number(l[0]),r=Number(l[1]);t>=o&&t<r&&(i=s)}});let e;return i>-1&&(e=this.colorArr[i]),e}gradientColor(t,i,e){let a=this.colorRgb(t),s=a[0],l=a[1],o=a[2],r=this.colorRgb(i),m=r[0],h=r[1],g=r[2],c=(m-s)/e,z=(h-l)/e,f=(g-o)/e,u=[];for(let v=0;v<e;v++){let C=this.colorHex("rgb("+parseInt(c*v+s)+","+parseInt(z*v+l)+","+parseInt(f*v+o)+")");u.push(C)}return u}colorRgb(t){let i=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,e=/rgb/;if(t=t.toLowerCase(),t&&i.test(t)){if(t.length===4){let s="#";for(let l=1;l<4;l+=1)s+=t.slice(l,l+1).concat(t.slice(l,l+1));t=s}let a=[];for(let s=1;s<7;s+=2)a.push(parseInt("0x"+t.slice(s,s+2)));return a}else if(e.test(t)){let a=[];for(let s=0;s<5;s++)a.push(this.rgbaNum(t,s));return a}else return t}rgbaNum(t,i){let e=t.match(/(\d(\.\d+)?)+/g);return Number(e[i])}_Ajax(t,i,e){d().ajax({url:t,type:"POST",dataType:"json",data:i,success:a=>{e(a)},error:a=>{at.log(a)}})}fit2Map(t,i){this.map.getView().fit(t,{size:this.map.getSize()}),i&&i()}createLegendPanel(t){d()("#mapChartsLegend_"+this.mapId).length>0&&d()("#mapChartsLegend_"+this.mapId).remove();let i=n(53725),e=`<div id="mapChartsLegend_${this.mapId}" style="position:absolute;z-index:10;box-shadow: 0px 1px 5px; background:rgb(255, 255, 255,${t.opacity});${t.style}">
                          <div id="legendContainer_${this.mapId}" style="border-radius: 3px;">`;t.hideTitle||(e+=`<div class="legendTitle" style="font-size: 14px;background: #409eff;color: #fff;border-top-left-radius: 3px;border-top-right-radius: 3px;text-align: center">
                       \u4E13\u9898\u56FE\u4F8B<span class="legendHide" style="cursor: pointer;position:relative;float:right;right:5px;" title="\u6700\u5C0F\u5316">&#8801;</span>
                    </div>`),e+=`<div id="legendContext_${this.mapId}" style="max-height:200px;overflow: auto;"></div>
                  </div>
                  <div id="showLegend_${this.mapId}" style="display:none;cursor: pointer;width: 32px;height: 32px;" title="\u4E13\u9898\u56FE\u4F8B">
                      <img src="${i}" style="background:rgb(255, 255, 255,${t.opacity});">
                  </div>
                </div>`,d()("#"+this.mapId).append(e),d()(".legendHide").off("click").click(()=>{d()("#legendContainer_"+this.mapId).hide(),d()("#showLegend_"+this.mapId).show()}),d()("#showLegend_"+this.mapId).off("click").click(()=>{d()("#legendContainer_"+this.mapId).show(),d()("#showLegend_"+this.mapId).hide()})}triangleArea(t,i,e){let a=0;return a=t[0]*i[1]+i[0]*e[1]+e[0]*t[1]-i[0]*t[1]-e[0]*i[1]-t[0]*e[1],a/2}getPolygonAreaCenter(t){let i=0,e=0,a=0,s=t[1],l,o;for(let h=2;h<t.length;h++)l=t[h],o=this.triangleArea(t[0],s,l),a+=o,i+=(t[0][0]+s[0]+l[0])*o,e+=(t[0][1]+s[1]+l[1])*o,s=l;let r=i/a/3,m=e/a/3;return[r,m]}getInnerPoint(t,i){let e={};return t.forEach(a=>{let s=a.getGeometry(),l=s.getType(),o=a.values_[i],r;if(l==="Polygon"){let m=s.getCoordinates();r=this.getPolygonAreaCenter(m[0])}else if(l==="MultiPolygon"){let m=s.getCoordinates();if(m.length===1)r=this.getPolygonAreaCenter(m[0][0]);else{let h=0,g=[];m.forEach(c=>{c[0].length>h&&(h=c[0].length,g=c[0])}),r=this.getPolygonAreaCenter(g)}}e[o]=r}),e}}class lt{constructor(t,i){this.map=t,this.util=new T(this.map),this.mapId=this.map.getTarget().id,this.onClickListener=i}init(t,i,e,a){if(this.options=t,this.features=i,this.xzqdm_field=e.xzqdm_field,this.legendConfig=e.options.legendConfig,this.chartTipsStyle=e.options.chartTipsStyle,this.data=t.data,it()(E()),this.modalType=a,e.xzqOption.isGeoJosn||e.xzqOption.layerUrl)this.positionPoint=this.util.getInnerPoint(i,e.xzqdm_field);else{let s=i[0].values_?i[0].values_:{};for(const l in s){let o=s[l]+"";l!=="geometry"&&o.indexOf(e.current_xzqdm+"")>-1&&o.length===e.xzq_length&&(this.xzqdm_field=l)}this.positionPoint=this.util.getInnerPoint(i,this.xzqdm_field)}this.createSeries(),this.map.render()}clear(){var t=d()("[id^=charts_]");if(t.length>0)for(let i=0;i<t.length;i++)t[i].parentElement.remove();this.clearLegend()}createSeries(){let t=this.data,i=0,e=0;this.modalType==="bar"&&Object.values(t).forEach(l=>{l.forEach(o=>{const r=Number(o.value);e=r>e?r:e})});const a=this.options.chartInfo;for(const s in t){let l=t[s];if(l.length>0){let o=[];l.forEach(m=>{let h={};h.name=m.name,h.y=Number(m.value),h.color=this.getColor(m.name),o.push(h)}),i+=1,this.createBar3D(o,i,e);const r=a[s];this.setOverLay(this.positionPoint[s],i,l,r)}}this.options.isShowChartLegend&&this.createLegend()}createBar3D(t,i,e){let a=this.options.baseWidth||50;this.chartTipsStyle.enabled&&this.chartTipsStyle.isDefault&&this.modalType!=="bar"&&(a=this.options.baseWidth||60);let s=a*t.length;s<100&&(s=100),d()("#"+this.mapId).find(".ol-overlaycontainer").append("<div id='charts_"+i+"' style='width:"+s+"px;height:80px;'></div>");let l={type:this.modalType==="bar"?"column":"pie",backgroundColor:"rgba(0,0,0,0)",margin:0,options3d:{enabled:!0,alpha:this.modalType==="bar"?15:55,beta:this.modalType==="bar"?15:0,depth:50,viewDistance:25}},o={text:""},r,m;if(this.modalType!=="bar"?(m={pie:{allowPointSelect:!0,cursor:"pointer",depth:15},series:{dataLabels:{enabled:!!this.chartTipsStyle.enabled&&this.chartTipsStyle.isDefault,allowOverlap:!0,padding:1,distance:5,format:"{point.name}:<br/>{y}",connectorPadding:1,style:{color:"#333333",fontSize:"10px",fontWeight:200,textOutline:"none"}}}},r=[{type:"pie",data:t}]):(m={column:{depth:25},series:{dataLabels:{enabled:!!this.chartTipsStyle.enabled&&this.chartTipsStyle.isDefault,allowOverlap:!0,padding:10,rotation:-45,y:-10,x:5,verticalAlign:"top",style:{color:"#333333",fontSize:"10px",fontWeight:200,textOutline:"none"}}}},r=[{name:"",data:t}]),this.chartTipsStyle.dataLabels&&this.chartTipsStyle.dataLabels!=="{}"){const g=JSON.parse(this.chartTipsStyle.dataLabels);m.series.dataLabels={...m.series.dataLabels,...g}}const h={};if(h.chart=l,h.title=o,h.series=r,h.plotOptions=m,h.credits={enabled:!1},h.legend={enabled:!1},h.xAxis={visible:!1},h.yAxis={visible:!1},this.modalType!=="bar"?(h.tooltip={enabled:!!this.chartTipsStyle.enabled&&!this.chartTipsStyle.isDefault,style:{fontSize:"12px"},pointFormat:"rat: {point.percentage:.1f}%<br/>val:{point.y}"},this.modalType==="ring"&&(h.plotOptions.pie.innerSize=25)):(h.yAxis={visible:!1,max:e},h.tooltip={enabled:!!this.chartTipsStyle.enabled&&!this.chartTipsStyle.isDefault,formatter:function(){return`<b> ${this.key} </b><br/> <span>${this.point.y}</span>`}}),this.chartTipsStyle.hoverStyle&&this.chartTipsStyle.hoverStyle!=="{}"){const g=JSON.parse(this.chartTipsStyle.hoverStyle);h.tooltip={...h.tooltip,...g}}E().chart("charts_"+i,h)}getColor(t){let i="";return this.options.legend.forEach(e=>{e.name===t&&(i=e.color)}),i}setOverLay(t,i,e,a){let s=new _.Z({position:t,positioning:"center-center",element:document.getElementById("charts_"+i)});this.map.addOverlay(s),this.onClickListener&&s.getElement().addEventListener("click",()=>{this.onClickListener(t,e,a)})}clearLegend(){d()("#rampLegend_"+this.mapId).length<1&&d()("#mapChartsLegend_"+this.mapId).length>0?d()("#mapChartsLegend_"+this.mapId).remove():d()("#chartLegend_"+this.mapId).length>0&&d()("#chartLegend_"+this.mapId).remove()}createLegend(){let t=this.legendConfig;d()("#mapChartsLegend_"+this.mapId).length>0?d()("#chartLegend_"+this.mapId).length>0&&d()("#chartLegend_"+this.mapId).remove():this.util.createLegendPanel(t);let i="";this.modalType==="bar"?i="\u67F1\u72B6\u56FE\u56FE\u4F8B":this.modalType==="pie"?i="\u997C\u56FE\u56FE\u4F8B":i="\u997C\u73AF\u56FE\u4F8B";let e=`<div id="chartLegend_${this.mapId}" style="font-size:12px;"><div> ${i}:</div>`;this.options.legend.forEach(a=>{e+='<div style="height:20px;padding:3px 5px;"><div style="background:'+a.color+';width:20px;height:15px;margin: 0px 5px;position:relative;float:left"></div><div style="position:relative;float:left;">'+a.name+"</div></div>"}),e+="</div>",d()("#legendContext_"+this.mapId).append(e)}}var I=n(49500);class ot{constructor(t,i,e){this.map=t,this.callback=e,this.geoJSON=new $.default,this.esrijsonFormat=new X.Z,this.util=new T(this.map),this._Ajax=this.util._Ajax,this.mapId=this.map.getTarget().id,this.currentZoom=7,this.isFiting=!1,this.onClickListener=i}initMapCharts(t){if(t)this.options=t;else{let i=n(52780);this.options=i.setting}if(this.xzqOption=this.options.xzqOption,this.rampOption=this.xzqOption.rampOption,this.selectOption=this.options.selectOption,this.chartOption=this.options.chartOption,this.chartOption.data){const e=Object.keys(this.chartOption.data)[0]+"",a=this.xzqOption.initXZQ+"";if(e.length<=a.length)return}this.currentZoom=this.options.zoomLevel||7,this.xzqdm_field=this.xzqOption.xzqdm_field,this.xzqmc_field=this.xzqOption.xzqmc_field,this.xzqFill=this.rampOption.fillColor?this.rampOption.fillColor:"rgba(5, 121, 138, 0.4)",this.xzqBorder=this.rampOption.borderColor?this.rampOption.borderColor:"rgba(5, 121, 138, 0.8)",this.legendColorObj=this.util.valueRangeColor(this.rampOption.valueRange,this.rampOption.rampColor,this.rampOption.isRampFill),this.setCurrentXZQ(),this.clear(),this.loadXZQ()}setCurrentXZQ(){this.current_xzqdm=this.xzqOption.initXZQ+"",this.xzqdm_down=null,this.xzq_length=this.current_xzqdm.length,this.xzq_length>=6?this.xzq_length+=3:this.xzq_length>1?this.xzq_length+=2:this.xzq_length+=1}loadXZQ(){let t=this.xzqOption.layerType;this.xzqOption.isGeoJson?this.createFeature(this.xzqOption.geojson):t==="geo-wfs"||t==="geoserver-wfs"?this.loadGeoserverWFS():t==="arc-vector"?this._Ajax(this.xzqOption.layerUrl,{f:"json"},i=>{let e=i.layers;for(let a=0;a<e.length;a++){const s=e[a].id;this.loadArcgisVector(s)}}):this.loadGeojson()}createFeature(t){if(!t)return;let i=[],e=t.features,a=t.wkid+"";a.indexOf("EPSG:")===-1&&(a="EPSG:"+a);for(let s=0;s<e.length;s++){const l=e[s].geometry,o=e[s].properties;let r=l.type,m;if(r.toLowerCase()==="polygon")m=new V.ZP(l.coordinates);else if(r.toLowerCase()==="multipolygon")m=new H.Z(l.coordinates);else{I.log("\u4E0D\u652F\u6301polygon/multiPolygon\u4EE5\u5916\u7684\u6570\u636E");return}m.applyTransform((0,U.getTransform)(a,this.map.getView().getProjection().getCode()));let h={geometry:m};for(const c in o)h[c]=o[c];let g=new J.Z(h);i.push(g)}this._GeoJson(i,"geojson")}loadGeojson(){D.h.getListByWhereClause({parentCode:this.current_xzqdm}).then(t=>{if(t.status===200&&t.data.length>0){let i={type:"FeatureCollection",features:[]};t.data.forEach((a,s)=>{let l=JSON.parse(a.geojsonGis);if(a.xzqCode&&(l.properties.xzqdm=a.xzqCode),a.xzqName&&(l.properties.xzqmc=a.xzqName),l.type==="FeatureCollection"){let o=null;l.features.forEach(r=>{let m=null;r.geometry.type==="Polygon"?m=(0,w.yu)(r.geometry.coordinates):r.geometry.type==="MultiPolygon"&&(m=(0,w.tw)(r.geometry.coordinates)),o==null?o=m:o=(0,M.Z)(o,m)}),o.properties=l.properties,l=o}i.features.push(l)}),this._GeoJson(i,"geo-wfs")}})}loadGeoserverWFS(){let t=this.xzqOption.layerUrl,i={service:"WFS",version:"1.1.0",request:"GetFeature",typeName:this.xzqOption.layerName,outputFormat:"application/json",maxFeatures:3200,srsName:this.map.getView().getProjection().getCode(),CQL_FILTER:this.xzqdm_field+" like '"+this.current_xzqdm+"%' and length("+this.xzqdm_field+")="+this.xzq_length};this._Ajax(t,i,e=>{this._GeoJson(e,"geo-wfs")})}loadArcgisVector(t){let i=this.map.getView().getProjection().getCode().split(":")[1],e=this.xzqOption.layerUrl+"/"+t+"/query",a={f:"json",outFields:"*",outSR:i,where:this.xzqdm_field+" like '"+this.current_xzqdm+"%' AND char_length("+this.xzqdm_field+")="+this.xzq_length};this._Ajax(e,a,s=>{s&&s.features.length>0&&this._GeoJson(s,"arc-vector")})}_GeoJson(t,i){let e;i==="geo-wfs"?e=this.geoJSON.readFeatures(t):i==="arc-vector"?e=this.esrijsonFormat.readFeatures(t):i==="geojson"&&(e=t),this.selectOption.isShowXzq&&this._addLayer(e),this.loadChart(e)}loadChart(t){if(this.selectOption.isShowCharts){let i=this.selectOption.chartType;this.chart=new lt(this.map,this.onClickListener);let e=JSON.parse(JSON.stringify(this.chartOption));e.isShowChartLegend=this.chartOption.isShowChartLegend&&this.options.legendConfig.isShow,this.chart.init(e,t,this,i)}}_addLayer(t){let i=this.xzqSource=new k.default;i.addFeatures(t);let e=this.xzqLayer=new Q.default({id:"mapCharts_xzq",source:i,zIndex:9999,style:s=>this.setXzqColor(s)});this.map.addLayer(e);let a=i.getExtent();this.fit2Map(a)}fit2Map(t){let i=this.map.getSize();this.isFiting=!0,this.map.getView().fit(t,{size:i,duration:800,callback:()=>{this.isFiting=!1;let e=this.map.getView().getZoom();this.currentZoom=e,this.selectOption.isShowRampLegend&&this.selectOption.isShowXzq&&this.xzqOption.isRamp&&this.options.legendConfig.isShow&&this.createLegend()}}),this.options.selectOption.isDrill?(this.initMousePosition(),this.drillDown()):this.drillDownEvt&&(0,q.B)(this.drillDownEvt)}setXzqColor(t){let e=(t.values_?t.values_:{})[this.xzqmc_field],a=this.getXzqdm(t.values_),s;if(!this.xzqOption.isRamp)s=this.xzqFill;else{let l=this.options.rampData[a];s=this.util.getColor(l),s=s||this.xzqFill}return this._getStyle(s,this.xzqBorder,e)}_getStyle(t,i,e){let a=new P.Z({color:t}),s=new K.Z({color:i,width:2}),l=new W.Z({text:e,font:"16px bold Microsoft YaHei ",fill:new P.Z({color:"#FFF"})}),o=new Y.ZP({fill:a,stroke:s});return this.xzqOption.isShowXzqName&&o.setText(l),o}clear(t){!t||t==="clearAll"?(this.clearLayer(),this.chart&&this.chart.clear()):t==="ramp"?this.clearRamp():this.chart&&this.chart.clear()}clearXzq(){let t=this.xzqSource.getFeatures();t.length>0&&t.forEach(i=>{this.xzqSource.removeFeature(i)})}clearLayer(){let t=this.map.getLayers().getArray();if(t.length>0){let i=[];t.forEach(e=>{e.values_.id==="mapCharts_xzq"&&i.push(e)}),i.forEach(e=>{this.map.removeLayer(e)})}this.drillDownEvt&&(0,q.B)(this.drillDownEvt),d()("#mapChartsLegend_"+this.mapId).length>0&&d()("#mapChartsLegend_"+this.mapId).remove(),this.isZoom=!1}clearRamp(){this.clearLegend(),this.xzqLayer.setStyle(t=>{let i=t.values_[this.xzqmc_field],e=this.xzqFill;return this._getStyle(e,this.xzqBorder,i)})}clearLegend(){d()("#chartLegend_"+this.mapId).length<1&&d()("#mapChartsLegend_"+this.mapId).length>0?d()("#mapChartsLegend_"+this.mapId).remove():d()("#rampLegend_"+this.mapId).length>0&&d()("#rampLegend_"+this.mapId).remove()}createLegend(){let t=this.options.legendConfig;d()("#mapChartsLegend_"+this.mapId).length>0?d()("#rampLegend_"+this.mapId).length>0&&d()("#rampLegend_"+this.mapId).remove():this.util.createLegendPanel(t);let i=`<div id="rampLegend_${this.mapId}" style="font-size:12px;"><div>\u6E10\u53D8\u8272\u56FE\u4F8B:</div>`;for(const e in this.legendColorObj)i+='<div style="height:20px;padding:3px 5px;"><div style="background:'+this.legendColorObj[e]+';width:20px;height:15px;margin: 0px 5px;position:relative;float:left"></div><div style="position:relative;float:left;">'+e+"</div></div>";i+="</div>",d()("#legendContext_"+this.mapId).append(i)}drillDown(){let t=this;this.drillDownEvt=this.map.getView().on("change:resolution",G().debounce(function(){if(t.isFiting)return;let i=t.map.getView().getZoom();if(Math.abs(t.currentZoom-i)>=1.3){let e=t.map.getView().getCenter(),a=t.options.drillFromMouse;if(t.drillPoint=a?t.mousePosition:e,t.callback){let s=i>=t.currentZoom,l=t.queryXZQDM(t.drillPoint,s);(s&&l&&l!==t.current_xzqdm||!s&&l&&l!==t.current_xzqdm)&&(I.log(l),t.callback(l))}t.currentZoom=i}},500))}queryXZQDM(t,i){let e=this.map.getLayerById("mapCharts_xzq");if(!e)return;let a=this.current_xzqdm,s=a.length;if(!i)s<=6&&s>2?a=a.substring(0,s-2):s>6&&(a=a.substring(0,s-3));else{let l=e.getSource().getFeaturesAtCoordinate(t);if(!l||l.length<1)return"";a=l[0].values_[this.xzqdm_field]}return a}getXzqdm(t){let i="";for(const e in t){let a=t[e]+"";e!=="geometry"&&a.indexOf(this.current_xzqdm+"")>-1&&a.length===this.xzq_length&&(i=a)}return i}initMousePosition(){this.map.getViewport().removeEventListener("mousemove",()=>{}),this.options.selectOption.drillFromMouse&&this.map.getViewport().addEventListener("mousemove",t=>{this.mousePosition=this.map.getEventCoordinate(t)})}}var nt=n(41739),rt=n(86892),ht=n(42709),dt=n(83574),pt=n(25400),mt=n(49500),gt={name:"GisThemeCharts",components:{HideButton:N.Z},mixins:[pt.Z,rt.D,R.u,j.H,ht.Z,dt.default],props:["widgetInfo"],data(){return this.mapCharts,{xzqdm:null,zoomwatch:!1,actionName:null,actionParam:null,isPostMessage:null}},watch:{xzqdm:function(p){this.zoomwatch&&(this.actionParam.xzq_code=p,b.Z.$emit(this.actionName,this.actionParam),this.isPostMessage&&this.doPostMessage(this.actionParam))}},beforeDestroy(){this.mapCharts&&this.mapCharts.clear()},mounted(){this.$nextTick(()=>{this.initMapCharts(),this.initAction(this.widgetInfo),this.loadInfo(this.widgetInfo)})},methods:{loadInfo(p){let t=this;nt.default.$on("mapSearch",i=>{t.zoomwatch=!i})},reLoadInfo(p){this.loadInfo(p),this.initMapCharts()},initAction(p){this.actionSendout(p),this.actionReceive(p)},initMapCharts(){this.$map&&(this.mapCharts||(this.mapCharts=new ot(this.$map,this.clickCharts,p=>{this.zoomwatch=!0,this.xzqdm=p})),this.initChartsData(this.widgetInfo),setTimeout(()=>{this.mapCharts.initMapCharts(this.widgetInfo.config)},1e3))},initChartsData(p){let t=p.dataset.type||"",e=(p.dataset||{})[t]||{};this.xzqdm&&(p.config.xzqOption.initXZQ=this.xzqdm),p.config.rampData={},p.config.chartOption.data={};let a=e.dimensions,s=e.encode.x,l=a.indexOf(s),o=e.encode.y,r=a.indexOf(o),m=e.encode.z,h=[];m.forEach(f=>{let u=a.indexOf(f);h.push(u)});const g={},c={};e.source.forEach(f=>{let u=f[l];this.$set(p.config.rampData,u,f[r]);let v=[];h.forEach(y=>{let O={value:f[y],name:e.dimensionsAlias[y].alias||e.dimensionsAlias[y].name};v.push(O)}),this.$set(p.config.chartOption.data,u,v);const C={};f.forEach((y,O)=>{const A=e.dimensionsAlias[O].name;C[A]=y,c[A]=e.dimensionsAlias[O].alias||A}),g[u]=C}),p.config.chartOption.chartInfo=g;const z=p.config.chartOption.legend;p.config.chartOption.legend=[],e.encode.z.forEach((f,u)=>{p.config.chartOption.legend.push({name:c[f]||f,color:z[u]?z[u].color:"#ff7300"})})},clickCharts(p,t,i){let e=this,a=this.widgetInfo.action.sendOut.actionList;this.$$lib__.each(a,s=>{if(s.enabled&&s.code==e.$$global_editor.actionType.clickCharts.code){let l=s.code+"_"+e.widgetInfo.id,o={positionPoint:p,data:t,info:i};if(s.paramsExtend&&s.paramsExtend.length>0&&this.getExtendParams(o,s.paramsExtend,i,[]),s.script&&s.script.enabled&&s.script.content){this.doConfigMap=new Function("data",s.script.content);let r=this.doConfigMap(o);r&&(o=r)}b.Z.$emit(l,o),s.postMessage&&this.doPostMessage(o),this.actionNameList.push(l)}})},onZoom(p,t,i){this.zoomwatch=!0,this.actionName=p,this.actionParam=t,this.isPostMessage=i},doShow(){this.initMapCharts()},doHide(){this.mapCharts&&this.mapCharts.clear()},doActionParams(p,t,i){let e=p.dataset.dynamic.query.params,a=Object.keys(t);for(let s in i)this.$$lib__.each(e,l=>{if(l.name==s){let o=i[s];this.$$lib__.contains(a,o)?(o==="xzq_code"&&(this.zoomwatch=!1,this.xzqdm=t[o]),l.defaultVal=t[o]):mt.warn("\u7EC4\u4EF6["+p.name+"]\u7684\u63A5\u6536\u4E8B\u4EF6\u53C2\u6570\u4E2D\uFF0Cdata\u6CA1\u6709["+o+"]\u8FD9\u4E2A\u5C5E\u6027")}});this.widgetInfo.dataset.dynamic.query.params=JSON.parse(JSON.stringify(e)),this.setFirstPage(),this.$emit("doGetPreviewData",JSON.parse(JSON.stringify(this.widgetInfo)))}}},ct=gt,ft=n(68141),ut=(0,ft.Z)(ct,L,F,!1,null,"c81fa09a",null),vt=ut.exports},53725:function(S){S.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAC4UlEQVRYR+2XQVLbQBBF/5+YJLsILoBdhb2NOUHMCTAniLNE3pATxJwgZmGzjHOC+AaIE+BsbaogFzDaAq7pVA+RLIOUSMLs4pWsmp5+6pn5/YdI/LzBtENyH4CXfL/G51DAcejvfI/mpD54X688vr4/I9lcY7LMqURkIncbe+HnWugANoezgMAHFyE8sUQASrhWGKFnBC2hdAi8EyC48et79AbTpiEvNJkl9sLDepA3scaG3cYk73hX7WQ+8IBbg1kPxBcBzm/8eivvZDoRwTO5q9S0lHnjXMUHszGJfQiOYwD9M+/We3knipdNeDLv7hzljdNx0UeXBvCGl20D+REltSK7RZbi2QCbg9k1ie0IINpQeavwLIA4+FE2Cx6E/s44D0RpAO/0qkq7uCCfCpUIlhuRmAhxnHWiSgNsDacjgB/zfKU71iKfwm5j9Hh8KQDvdNYygrO8yZ2mCUIxld3wsHadjCsFsKKWBSjS9kZhAG1ShvxWIO9yaIq+lAMAq2kAQhyptmfBpcl7YYC/fXnWsXR7APLzxm886bBrBVjR9gSpCH4JpJ2mkGsHcF1O5VnQAq1nwQluK6OsJvUiAEU26H+AUhVwWmAYd8Co5PPD+nHc4w3ESTBwDivVNBku7QeUWg2L6wfklSYxFi19pzIN5/mk6caoywKQZXBKVUCDLB86noE0raBvwLYm2RxOJ3reFU7AKgXOV74IwJ/kgXHKSE/tmHo8MehrRRTSyEO7Xj+AqYwgi22I1HR942XR6kDGMPQUIt4fGR6z9BK49R5MmyBbICbRHliCXPbt3ase3sIzdtEpVIF/2fJoY60IDqU69xsdPSEwGwHsvafSq84JsmiHfr2fJlCxsVFbvnJRKOhui6hfNDZp69QrrFzN1MGQGFkgl7ksDCCil5meesqoUy4vp2/uA4LvC09aIkCTCzfaatUcQFye4UzNRRuCatL3l8jxJETbM4hr0eomOuVvp7hPE51KsTcAAAAASUVORK5CYII="}}]);
