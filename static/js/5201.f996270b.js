"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[5201],{75201:function(C,c,l){l.r(c),l.d(c,{default:function(){return b}});var u=function(){var e=this,s=e._self._c;return s("div",[s("button-tooltip",{attrs:{button_config:e.button_info}},[s("el-popover",{attrs:{trigger:e.button_info.trigger,placement:"bottom-end","popper-class":"query-popover-customer-fields"}},[e.accessType!=e.global_query.accessType.public.code?s("div",{style:{overflowY:"auto",maxHeight:e.table_height+"px"}},[s("el-tree",{ref:"refCustomerFieldsTree",attrs:{data:e.customer_fields_tree,"default-checked-keys":e.default_checked_keys!=null?e.default_checked_keys:e.displayCustomerFields,"node-key":"id","show-checkbox":""},on:{check:e.handleCheck},scopedSlots:e._u([{key:"default",fn:function({node:i,data:n}){return s("span",{},[n.id=="check_all"?s("el-tooltip",{attrs:{"open-delay":1e3,content:"\u5168\u9009/\u53D6\u6D88\u5168\u9009",effect:"light",placement:"top"}},[s("span",{class:n.isCustomerField==!0?"query-popover-customer-fields-tree-node-active":""},[e._v(" "+e._s(i.label)+" ")])]):n.isCustomerField?s("el-tooltip",{attrs:{"open-delay":1e3,content:"\u5DF2\u8BBE\u7F6E\u6B64\u5217\u81EA\u5B9A\u4E49\u663E\u793A",effect:"light",placement:"top"}},[s("span",{staticClass:"query-popover-customer-fields-tree-node-active"},[e._v(" "+e._s(i.label)+" ")])]):s("el-tooltip",{attrs:{"open-delay":1e3,content:"\u5C1A\u672A\u81EA\u5B9A\u4E49\u663E\u793A",effect:"light",placement:"top"}},[s("span",[e._v(" "+e._s(i.label)+" ")])])],1)}}],null,!1,698274263)})],1):e._e(),s("div",{staticClass:"query-popover-customer-fields-button"},[s("el-button",{attrs:{size:"mini",type:"primary"},on:{click:function(i){return e.saveCustomerFields(e.button_info,"new")}}},[e._v("\u4FDD\u5B58\u8BBE\u7F6E ")]),s("el-button",{attrs:{size:"mini",type:"info"},on:{click:function(i){return e.saveCustomerFields(e.button_info,"recovery")}}},[e._v("\u8FD8\u539F\u9ED8\u8BA4 ")])],1),e.accessType!=e.global_query.accessType.public.code?s("el-button",{class:`gisq-query-button el-button--${e.button_info.colorType}`,style:e.buttonStyle(e.button_info),attrs:{slot:"reference",circle:e.button_info.style=="circle",disabled:e.button_info.disabled,plain:e.button_info.style=="plain",round:e.button_info.style=="round",size:e.button_info.size,type:e.button_info.style=="text"?"text":""},on:{click:function(i){return e.onClickButton(e.button_info)}},slot:"reference"},[!e.button_info.icon_align||e.button_info.icon_align==e.global_query.position.left.code?s("i",{class:e.button_info.icon}):e._e(),e._v(" "+e._s(e.button_info.label)+" "),e.button_info.icon_align==e.global_query.position.right.code?s("i",{class:e.button_info.icon}):e._e(),s("i",{staticClass:"el-icon-arrow-down el-icon--right"})]):e._e()],1)],1)],1)},d=[],f=l(78931),o=l(55616),a=l(48836),h=l(79876),_=l(52013),p=l(50707),y=l(27966),r=l(49500),g={name:"customer-fields",components:{ButtonTooltip:_.Z},props:{button_info:{}},mixins:[h.G],data(){return{global_query:this.$$global_query,displayCustomerFields:[],default_checked_keys:null,all_keys:[]}},computed:{...(0,a.Se)(["view_height_fun"]),view_height(){return this.view_height_fun(this.widgetId)},customer_fields_tree(){let t=this,e=[];return t.all_keys=[],t.default_checked_keys=t.customerFields,t.displayCustomerFields=[],t.$$lib__.each(t.queryConfig.field,s=>{JSON.parse(JSON.stringify(s)).hide||(t.all_keys.push(s.guid),s.default_display&&t.displayCustomerFields.push(s.guid),e.push({id:s.guid,label:s.label&&s.label!=""?s.label:s.field,isCustomerField:t.getIsCustomerField(s.guid)}))}),e=t.$$lib__.sortBy(e,"order"),e.length>0&&(t.default_checked_keys!=null?t.$$lib__.difference(t.all_keys,t.default_checked_keys).length==0&&t.default_checked_keys.push("check_all"):t.displayCustomerFields&&t.$$lib__.difference(t.all_keys,t.displayCustomerFields).length==0&&t.displayCustomerFields.push("check_all"),e.unshift({id:"check_all",label:"\u5168\u9009",isCustomerField:t.getIsCustomerField("check_all")})),e},table_height(){return this.view_height.page-this.view_height.header-this.view_height.footer}},mounted(){y.Z.$on("busUpdateCustomerFields"+(this.widgetId?"_"+this.widgetId:""),(t,e)=>{(t!=null||t!=null)&&(t=t instanceof Array?t:[t.toString()]),this.doSaveCustomerFields(t,e)})},methods:{...(0,a.nv)(["setCustomerFields"]),handleCheck(t,e){let s=[];if(t.id=="check_all")this.$$lib__.difference(this.all_keys,e.checkedKeys).length>0&&(s=JSON.parse(JSON.stringify(this.all_keys)));else{let i=this.$refs.refCustomerFieldsTree.getCheckedNodes();s=this.$$lib__.pluck(i,"id"),this.$$lib__.difference(this.all_keys,e.checkedKeys).length==0?s.push("check_all"):s=this.$$lib__.without(s,"check_all")}this.setCustomerFields({customerFields:s,widgetId:this.widgetId})},saveCustomerFields(t,e){let s=null;if(e=="new"){let i=this.$refs.refCustomerFieldsTree.getCheckedNodes();s=this.$$lib__.pluck(i,"id")}if(t.is_click){if(!t.script_click||t.script_click==""){r.warn("\u6309\u94AE\u70B9\u51FB\u4E8B\u4EF6 \u6309\u94AE"+t.name+" \u811A\u672C\u4E3A\u7A7A");return}r.info("\u6267\u884C\u6309\u94AE\u70B9\u51FB\u4E8B\u4EF6 \u6309\u94AE"+t.name+" \u811A\u672C"),new Function("customerFieldsInfo",t.script_click).apply(this,[s])}else this.doSaveCustomerFields(s)},doSaveCustomerFields(t,e){let s=t!=null?JSON.stringify(t):null;if(this.accessType){if(this.queryId==null&&this.queryPublishId==null){r.error("\u67E5\u8BE2\u5217\u8868ID\u548C\u7248\u672CID  \u81F3\u5C11\u6709\u4E00\u4E2A"),o.Message.error({message:"\u53C2\u6570\u6709\u8BEF\uFF0C\u65E0\u6CD5\u4FDD\u5B58",offset:60});return}switch(this.accessType){case this.global.editType.original.code:p._.saveCustomerFields(s,this.queryId,this.queryPublishId).then(i=>{this.afterSave(t,i,e)});break;case this.global.editType.public.code:o.Message.error({message:"\u516C\u5F00\u7248\u672C\uFF0C\u65E0\u6CD5\u83B7\u53D6\u7528\u6237\u4FE1\u606F\uFF0C\u5373\u65E0\u6CD5\u4F7F\u7528\u6B64\u529F\u80FD",offset:60});break;default:o.Message.error({message:"\u53C2\u6570\u6709\u8BEF\uFF0C\u65E0\u6CD5\u4FDD\u5B58",offset:60})}}else this.queryId?f.y.saveCustomerFields(s,this.queryId).then(i=>{this.afterSave(t,i,e)}):o.Message.error({message:"\u53C2\u6570\u6709\u8BEF\uFF0C\u65E0\u8BBE\u67E5\u8BE2\u5217\u8868\u4E3B\u952E\uFF0C\u65E0\u6CD5\u4FDD\u5B58",offset:60})},afterSave(t,e,s){e&&e.status==200?(this.setCustomerFields({customerFields:t,widgetId:this.widgetId}),s&&s(),o.Message.success({message:t!=null?"\u4FDD\u5B58\u6210\u529F":"\u8FD8\u539F\u6210\u529F",offset:60})):o.Message.error({message:e.msg,offset:60})},getIsCustomerField(t){let e=this.default_checked_keys!=null?this.default_checked_keys:this.displayCustomerFields;return this.$$lib__.contains(e,t)},onClickButton(t){this.buttonClick(t)},buttonClick(t){if(!t.is_click)return;if(!t.script_click||t.script_click==""){r.warn("\u6309\u94AE\u70B9\u51FB\u4E8B\u4EF6 \u6309\u94AE"+t.name+" \u811A\u672C\u4E3A\u7A7A");return}r.info("\u6267\u884C\u6309\u94AE\u70B9\u51FB\u4E8B\u4EF6 \u6309\u94AE"+t.name+" \u811A\u672C"),new Function(t.script_click).apply(this)},scriptClick(){this.refTable.clearSelection()}}},m=g,v=l(68141),k=(0,v.Z)(m,u,d,!1,null,"40fe5fa8",null),b=k.exports}}]);
