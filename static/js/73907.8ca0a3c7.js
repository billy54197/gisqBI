"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[73907],{520087:function(N,x,s){s.r(x),s.d(x,{setting:function(){return E}});let E={isGeoJson:!1,geojson:void 0,layerUrl:"http://192.168.11.48:8080/geoserver/pg/ows",layerType:"geo-wfs",initLayer:0,layerName:"pg:st_xmtx_p_p",colorConfig:{fillColor:"rgba(0,204,204,0.8)",borderColor:"#00FF00",font:{borderColor:"#fff",fontColor:"#fff",size:12,borderWidth:3}},distance:30,isShowNum:!0,radius:void 0,isShowBorder:!1}},473907:function(N,x,s){s.r(x),s.d(x,{default:function(){return Y}});var E=function(){var r=this,e=r._self._c;return e("div",{directives:[{name:"show",rawName:"v-show",value:r.widgetInfo.attr.hide!==!0,expression:"widgetInfo.attr.hide !== true"}],ref:"gis-theme-cluster",style:{width:r.widgetInfo.attr.w+"px",height:r.widgetInfo.attr.hh+"px"},attrs:{map:r.map}},[e("hide-button",{attrs:{attr:r.widgetInfo.attr}})],1)},I=[],T=s(844513),M=s(445061),S=s(126711),O=s(653183),w=s.n(O),j=s(313811),D=s(413798),A=s(144727),y=s(507522),l=s(372449),t=s(2487),i=s(60281),n=s(682571),u=s(505689),p=s(568640),v=s(23230),m=s(195659),C=s(390583),L=s(337564),R=s(131751),Z=s(776094),F=s(149500);class z{constructor(r){this.map=r,this.geoJSON=new L.default,this.esrijsonFormat=new R.Z}initCluster(r){let e=[];if(r)this.options=r;else{let o=s(520087);this.options=o.setting}this.clear(),this.options.isGeoJson?(e=this.createFeatur(),this._addClusterData(e,"geojson")):this.options.layerUrl&&this.loadVecData()}createFeatur(){let r=[],e;this.options.geojson?e=this.options.geojson:e=s(30512);let o=this.map.getView().getProjection().getCode();e.wkid?(o=e.wkid,o.indexOf("EPSG:")===-1&&(o="EPSG:"+o)):e.spatialReference&&(o="EPSG:"+e.spatialReference.wkid);let a=e.features;for(let c=0;c<a.length;c++){const d=a[c];let h,g,f=d.geometry.type;if(f.toLowerCase()==="point")g=h=new D.Z(d.geometry.coordinates),g.applyTransform((0,C.getTransform)(o,this.map.getView().getProjection().getCode()));else if(f.toLowerCase()==="polygon")h=new A.ZP(d.geometry.coordinates),h.applyTransform((0,C.getTransform)(o,this.map.getView().getProjection().getCode())),g=h.getInteriorPoint();else if(f.toLowerCase()==="multiPolygon")h=new y.Z(d.geometry.coordinates),h.applyTransform((0,C.getTransform)(o,this.map.getView().getProjection().getCode())),g=new D.Z((0,Z.getCenter)(h.getExtent()));else{alert("\u5B58\u5728\u4E0D\u652F\u6301\u805A\u5408\u7684\u56FE\u5F62\u7C7B\u578B");return}r[c]=new j.Z(g)}return r}loadVecData(){this.options.layerType==="geo-wfs"?this.loadGeoserverWFS():this.options.layerType==="arc-vector"?this.loadArcgisVector():F.log("\u6682\u4E0D\u652F\u6301\u5176\u4ED6\u670D\u52A1\u7C7B\u578B")}loadGeoserverWFS(){var r=this.options.layerUrl,e={service:"WFS",version:"1.1.0",request:"GetFeature",typeName:this.options.layerName,outputFormat:"application/json",maxFeatures:1e5,srsName:this.map.getView().getProjection().getCode(),CQL_FILTER:"1=1"};this._Ajax(r,e,o=>{this._addClusterData(o,"geo-wfs")})}loadArcgisVector(){let r=this.map.getView().getProjection().getCode().split(":")[1],e=this.options.layerUrl+"/"+this.options.initLayer+"/query",o={f:"json",outSR:r,outFields:"*",where:"1=1"};this._Ajax(e,o,a=>{this._addClusterData(a,"arc-vector")})}_addClusterData(r,e){this.clusters&&this.map.removeLayer(this.clusters);let o;e==="geo-wfs"?o=this.geoJSON.readFeatures(r):e==="arc-vector"?o=this.esrijsonFormat.readFeatures(r):e==="geojson"&&(o=r),o=w().grep(o,h=>h.get("geometry"));let a=new t.default({features:o});F.log(a);let c=new i.Z({distance:this.options.distance,source:a,geometryFunction:h=>{let g,f=h.getGeometry();if(f.getType()==="Point")g=f;else if(f.getType()==="Polygon")g=f.getInteriorPoint();else if(f.getType()==="MultiPolygon")g=new D.Z((0,Z.getCenter)(f.getExtent()));else return null;return g}}),d={};this.clusters=new l.default({id:"clusters_xzq",source:c,zIndex:9999,style:h=>this.setStyle(d,h)}),this.map.addLayer(this.clusters)}setStyle(r,e){let o=e.get("features").length,a=r[o],c=[],d=this.options.radius?this.options.radius:o.toString().length*5,h=this.map.getView().getMaxZoom(),g=this.map.getView().getZoom();if(o>1&&g<h-3)a=new n.ZP({text:this.style_text(o)}),a.setImage(this.style_circle(d,o)),r[o]=a,c.push(a);else{let f=e.get("features");for(let G=0;G<f.length;G++){const V=f[G];let W=V.getGeometry().getType();if(W==="Polygon"||W==="MultiPolygon"){let b=this.setPolygonStyle(V);c.push(b)}else a=new n.ZP({text:this.style_text(o)}),a.setImage(this.style_circle(d,o)),r[o]=a,c.push(a)}}return c}style_circle(r,e){let o=this.options.colorConfig.FillColorIndex,a=this.options.colorConfig.scopeIndex?this.options.colorConfig.scopeIndex:"50",c=[],d="";for(let f=0;f<o;f++)c[f]=this.options.colorConfig["fillColor"+f]?this.options.colorConfig["fillColor"+f]:"rgba(144, 238, 144, 1)";let h=Math.ceil(e/a);return o==1?d=c[0]:h<o?d=c[h-1]:h>=o&&(d=c[o-1]),new u.Z({radius:r>10?r:10,fill:new p.Z({color:d}),stroke:this.options.isShowBorder?new v.Z({color:this.options.colorConfig.borderColor}):void 0})}style_text(r){let e="";return this.options.isShowNum&&(e=new m.Z({text:r.toString(),font:this.options.colorConfig.font.size+"px serif",fill:new p.Z({color:this.options.colorConfig.font.fontColor}),stroke:new v.Z({color:this.options.colorConfig.font.borderColor,width:this.options.colorConfig.font.borderWidth})})),e}setPolygonStyle(r){let e=this.options.colorConfig;return new n.ZP({geometry:r.getGeometry(),fill:new p.Z({color:e.fillColor}),stroke:new v.Z({color:e.borderColor,width:1}),text:new m.Z({text:r.text,textAlign:"center",textBaseline:"middle",font:e.font.size+"px serif",fill:new p.Z({color:e.font.fontColor}),stroke:new v.Z({color:e.font.borderColor,width:e.font.borderWidth})})})}clear(){let r=this.map.getLayers().getArray(),e=[];r.forEach(o=>{o.values_.id==="clusters_xzq"&&e.push(o)}),e.forEach(o=>{this.map.removeLayer(o)})}_Ajax(r,e,o){w().ajax({url:r,type:"POST",dataType:"json",data:e,success:a=>{o(a)},error:a=>{F.log(a)}})}}var U=s(641739),B=s(386892),K=s(242709),J=s(783574),H={name:"GisThemeCluster",components:{HideButton:T.Z},mixins:[B.D,M.u,S.H,K.Z,J.default],props:["widgetInfo"],data(){return this.cluster,{xzqdm:null,zoomwatch:!1,actionName:null,actionParam:null,isPostMessage:null}},computed:{},watch:{},beforeDestroy(){this.cluster&&this.cluster.clear()},mounted(){this.loadInfo(this.widgetInfo),this.initCluster(),this.initAction(this.widgetInfo)},methods:{loadInfo(P){let r=this;U.default.$on("mapSearch",e=>{r.zoomwatch=!e})},reLoadInfo(P){this.loadInfo(P),this.initCluster()},initAction(P){this.actionSendout(P),this.actionReceive(P)},initCluster(){this.$map&&!this.cluster&&(this.cluster=new z(this.$map)),this.cluster.initCluster(this.widgetInfo.config)},onZoom(P,r,e){this.zoomwatch=!0,this.actionName=P,this.actionParam=r,this.isPostMessage=e},doShow(){this.initCluster()},doHide(){this.cluster&&this.cluster.clear()}}},$=H,X=s(768141),Q=(0,X.Z)($,E,I,!1,null,"35d41811",null),Y=Q.exports},60281:function(N,x,s){var E=s(302073),I=s(313811),T=s(413798),M=s(2487),S=s(866884),O=s(312059),w=s(776094),j=s(95232),D=function(){var y=function(l,t){return y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,n){i.__proto__=n}||function(i,n){for(var u in n)Object.prototype.hasOwnProperty.call(n,u)&&(i[u]=n[u])},y(l,t)};return function(l,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");y(l,t);function i(){this.constructor=l}l.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}(),A=function(y){D(l,y);function l(t){var i=y.call(this,{attributions:t.attributions,wrapX:t.wrapX})||this;return i.resolution=void 0,i.distance=t.distance!==void 0?t.distance:20,i.minDistance=t.minDistance||0,i.interpolationRatio=0,i.features=[],i.geometryFunction=t.geometryFunction||function(n){var u=n.getGeometry();return(0,O.h)(u.getType()=="Point",10),u},i.createCustomCluster_=t.createCluster,i.source=null,i.boundRefresh_=i.refresh.bind(i),i.updateDistance(i.distance,i.minDistance),i.setSource(t.source||null),i}return l.prototype.clear=function(t){this.features.length=0,y.prototype.clear.call(this,t)},l.prototype.getDistance=function(){return this.distance},l.prototype.getSource=function(){return this.source},l.prototype.loadFeatures=function(t,i,n){this.source.loadFeatures(t,i,n),i!==this.resolution&&(this.resolution=i,this.refresh())},l.prototype.setDistance=function(t){this.updateDistance(t,this.minDistance)},l.prototype.setMinDistance=function(t){this.updateDistance(this.distance,t)},l.prototype.getMinDistance=function(){return this.minDistance},l.prototype.setSource=function(t){this.source&&this.source.removeEventListener(E.Z.CHANGE,this.boundRefresh_),this.source=t,t&&t.addEventListener(E.Z.CHANGE,this.boundRefresh_),this.refresh()},l.prototype.refresh=function(){this.clear(),this.cluster(),this.addFeatures(this.features)},l.prototype.updateDistance=function(t,i){var n=t===0?0:Math.min(i,t)/t,u=t!==this.distance||this.interpolationRatio!==n;this.distance=t,this.minDistance=i,this.interpolationRatio=n,u&&this.refresh()},l.prototype.cluster=function(){if(!(this.resolution===void 0||!this.source))for(var t=(0,w.createEmpty)(),i=this.distance*this.resolution,n=this.source.getFeatures(),u={},p=0,v=n.length;p<v;p++){var m=n[p];if(!((0,j.sq)(m)in u)){var C=this.geometryFunction(m);if(C){var L=C.getCoordinates();(0,w.createOrUpdateFromCoordinate)(L,t),(0,w.buffer)(t,i,t);var R=this.source.getFeaturesInExtent(t).filter(function(Z){var F=(0,j.sq)(Z);return F in u?!1:(u[F]=!0,!0)});this.features.push(this.createCluster(R,t))}}}},l.prototype.createCluster=function(t,i){for(var n=[0,0],u=t.length-1;u>=0;--u){var p=this.geometryFunction(t[u]);p?(0,S.IH)(n,p.getCoordinates()):t.splice(u,1)}(0,S.bA)(n,1/t.length);var v=(0,w.getCenter)(i),m=this.interpolationRatio,C=new T.Z([n[0]*(1-m)+v[0]*m,n[1]*(1-m)+v[1]*m]);return this.createCustomCluster_?this.createCustomCluster_(C,t):new I.Z({geometry:C,features:t})},l}(M.default);x.Z=A}}]);
