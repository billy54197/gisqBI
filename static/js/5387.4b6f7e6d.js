"use strict";(self.webpackChunkdatavisual=self.webpackChunkdatavisual||[]).push([[5387],{37531:function(M,x,s){s.r(x),s.d(x,{default:function(){return X}});var C=s(62735),c=s(14888),S=s(42447),E=s(90583),L=s(55979),Z=s(33288),m=s(7522),f=s(44727),T=s(13811),F=s(82571),R=s(95659),y=s(23230),O=s(68640),N=s(76094),I=s(55616),H=s(65598),D=s.p+"static/img/greenBubble.f0a741be.png",q=s.p+"static/img/yellowBubble.45498762.png",k=s(21300),A=s(68433),j=s(53183),b=s.n(j),w=s(49500);class U{constructor(t){this.map=t.map,this.config=t.configManager.config,this.parames=new L.Z;let l=this.map.interactions;this.isZoom=!0,this.currentZoom=7,l.forEach(i=>{i instanceof H.Z&&i.setActive(!1)}),this.xzqdm_length=2,this.mapResolution=null}initBubble(t,l){this.callback=l,this.option=t,this.calculation_R_Size_K(),this.xzqdm_field=this.option.xzqdm_field?this.option.xzqdm_field:"xzqdm",this.xzqmc_field=this.option.xzqmc_field?this.option.xzqmc_field:"xzqmc",b()(".ol-overlaycontainer").empty(),this.isZoom=!1,setTimeout(()=>{this.getMapData(),this.map.render()},1e3)}zoomEventFun(){let t=this;this.zoomEvent=this.map.getView().on("change:resolution",l=>{let i=this.map.getView().getMinZoom();i<7&&(w.log("\u521D\u59CB\u8BBE\u7F6E\u5730\u56FE\u6700\u5C0F\u7F29\u653E\u7EA7\u522B\u65E0\u4F5C\u7528\uFF1A"+i),this.map.getView().setMinZoom(7),this.map.getView().setMaxZoom(12)),t.isZoom&&t.zoomDrillFun(l)})}calculation_R_Size_K(){let t=this.option.totaldata,l=this.option.bubbleMaxR,i=this.option.bubbleMinR;this.maxValue=-1/0,this.minValue=1/0;for(const o in t)t[o].data.forEach(a=>{let h=a.value=="null"||a.value=="NULL"?0:a.value,n=Number(h);this.maxValue<n&&(this.maxValue=n),this.minValue>n&&(this.minValue=n)});let e=this.maxValue-this.minValue;this.maxR=l||50,this.minR=i||38,this.K=(this.maxR-this.minR)/e}zoomDrillFun(t){let l=t.oldValue,i=t.target.values_.resolution,e=l>i,o=null;if(e){let a=b()(".mousePosition")[0].innerHTML;if(a=="&nbsp;")o=this.map.getView().getCenter();else{let h=a.split(",");o=[Number(h[0]),Number(h[1])]}}else o=this.map.getView().getCenter();let r=this.map.getPixelFromCoordinate(o);this.xzqQuery(r,e)}clearBubble(){b()(".ol-overlay-container.ol-selectable").remove();let l=this.map.getLayerById("drawLayer").getSource();l.getFeatures().forEach(e=>{e.featureType=="bubbleMap"&&l.clear(e)}),this.zoomEvent&&((0,A.B)(this.zoomEvent),this.zoomEvent=null)}getMapData(){let t=this.config;if(t.toc&&t.toc.length>0){let l=t.toc,i=b().grep(l,e=>e.layerTag==this.option.layerTag);if(i.length<1){if(this.callback){let e={success:!1,mode:this.option.mode,message:"\u56FE\u5C42\u4E0D\u5B58\u5728"};this.callback(e)}this.isZoom=!0,(0,I.Message)({message:"\u672A\u67E5\u8BE2\u5230\u6570\u636E",center:!0,type:"warning"})}else{let e=i[0];this.featureLayer=e,this.queryTask=new S.Z(e),this._getFeature(e)}}else{if(this.callback){let l={success:!1,mode:this.option.mode,message:"\u56FE\u5C42\u4E0D\u5B58\u5728"};this.callback(l)}this.isZoom=!0,(0,I.Message)({message:"\u672A\u67E5\u8BE2\u5230\u6570\u636E",center:!0,type:"warning"})}}_getFeature(){let t=this.option.totaldata;if(this.parames.where="",JSON.stringify(t)!=="{}"){for(const l in t)if(l){this.xzqdm_length=l.length;let i="";l.length<=6?i=l.substr(0,l.length-2):i=l.substr(0,l.length-3),this.parames.where=this.xzqdm_field+" like '"+i+"%' and length("+this.xzqdm_field+")="+l.length;break}}else if(this.parentXzqdm){let l=this.parentXzqdm.length;this.parentXzqdm.length<6?l+=2:this.parentXzqdm.length>=6&&(l+=3),this.parames.where=this.xzqdm_field+" like '"+this.parentXzqdm+"%' and length("+this.xzqdm_field+")="+l}else return;this.parames.srsName=this.map.getView().getProjection().getCode(),this.queryTask.execute(this.parames).then(l=>{if(l&&l.features&&l.features.length>0){this.clearBubble();let i=l.features;this._handleAllFeatures(i),this.zoomEventFun()}else{if(this.callback){let i={success:!1,mode:this.option.mode,message:"\u672A\u67E5\u8BE2\u5230\u6570\u636E"};this.callback(i)}this.isZoom=!0,w.log("\u672A\u67E5\u8BE2\u5230\u6570\u636E")}})}_handleAllFeatures(t){this.centerPointObj={};let l=Number(this.option.xzqExtentSize?this.option.xzqExtentSize:1);this.featureExtent=[1/0,1/0,-1/0,-1/0],t.forEach(e=>{let o=e.geometry,r=o.type,a=e.properties[this.xzqdm_field],h=e.properties[this.xzqmc_field],n=null;if(r=="MultiPolygon")n=new m.Z(o.coordinates);else if(r=="Polygon")n=new f.ZP(o.coordinates);else return;let u=(0,N.getCenter)(n.getExtent());this.centerPointObj[a]=u;let z=this.option.fillColor?this.option.fillColor:"rgba(5, 121, 138, 0.2)",g=this.option.borderColor?this.option.borderColor:"rgba(5, 121, 138, 0.2)",p=new T.Z({geometry:n});p.featureType="bubbleMap",p.properties=e.properties,p.area=n.getArea(),p.setStyle(this._getStyle(z,g,h)),this.map.getLayerById("drawLayer").getSource().addFeature(p),this.getfeatureExtent(u),this.circleHtml(a)}),this.mapResolution||(this.mapResolution=this.map.getView().getResolution());let i=this.mapResolution/l;this.isZoom=!1,this.map.getView().setResolution(i),setTimeout(()=>{this.isZoom=!0},200)}circleHtml(t){let l=this,i=this.option.totaldata[t];if(i){let e=i.data,o=this.option.totaldata[t].positionPoint;if(!e)return;let r="";e.forEach((a,h)=>{let n=a.value=="null"||a.value=="NULL"?0:a.value,u=Number(n),g=2*(this.K*(u-this.minValue)+this.minR),p=(0,Z.GW)(),K="<div class='labelTooltip2' id='bubblecharts_"+p+"' title='"+a.name+" : "+u+"' style='cursor: pointer;'></div>";b()(".ol-overlaycontainer").append(K);let v=o[0],V=this.option.bubbleColor_1?this.option.bubbleColor_1:"rgba(249, 207, 4, 0.8)",P=this.option.bubbleImgURL_1?k.appendImageBaseURL(this.option.bubbleImgURL_1):q;if(h==1&&(v=o[1],V=this.option.bubbleColor_2?this.option.bubbleColor_2:"rgba(7, 214, 52, 0.9)",P=this.option.bubbleImgURL_2?k.appendImageBaseURL(this.option.bubbleImgURL_2):D),this.option.isBubbleImage)r=this.imgHtml(g,a,P,h);else{let d=g-32;r=this.bubbleHtml(V,d,u,h,a.name)}b()("#bubblecharts_"+p).append(r);let Q=this.option.wkid,W=this.map.getView().getProjection().getCode();v=(0,E.transform)(v,Q,W);let B=new C.Z({position:v,positioning:"center-center",stopEvent:!1,element:document.getElementById("bubblecharts_"+p)});if(B.getElement().addEventListener("click",d=>{w.log("bubblecharts_"+p,d,i,h);let Y={xzqdm:i.xzqdm,data:a,position:v};l.onClickListener&&l.onClickListener(Y)}),this.map.addOverlay(B),this.option.bubbleFloat){let d=b()("#bubblecharts_"+p).parent();b()(d).css("-webkit-animation","bubbleAnimation "+(Math.random()+2)+"s ease infinite alternate"),b()(d).css("-o-animation","bubbleAnimation "+(Math.random()+2)+"s ease infinite alternate"),b()(d).css("animation","bubbleAnimation "+(Math.random()+2)+"s ease infinite alternate")}})}}_getStyle(t,l,i){let e=new O.Z({color:t}),o=new y.Z({color:l,width:1}),r=new R.Z({text:i,font:"16px bold Microsoft YaHei ",fill:new O.Z({color:"#FFFFFF"})}),a=new F.ZP({fill:e,stroke:o});return this.option.isShowXzqName&&a.setText(r),a}getfeatureExtent(t){t[0]<this.featureExtent[0]&&(this.featureExtent[0]=t[0]),t[1]<this.featureExtent[1]&&(this.featureExtent[1]=t[1]),t[0]>this.featureExtent[2]&&(this.featureExtent[2]=t[0]),t[1]>this.featureExtent[3]&&(this.featureExtent[3]=t[1])}xzqQuery(t,l){let i=this.map.getFeaturesAtPixel(t);if(!i)return;let e=i[0].properties[this.xzqdm_field],o=e.length;if(l==!0||l==!1){let r=this.map.getSize(),a=this.map.getView().calculateExtent(r),h=(0,N.getArea)(a),u=i[0].area/h;if((u>.3||e=="3309")&&l){if(this.xzqdm_up==e)return;this.xzqdm_down=null,this.xzqdm_up=e,this.parentXzqdm=e,w.log(e),c.Z.$emit("fit2region",{xzqdm:e,flag:l})}if(u<.1&&!l){if(o<6?e=e.substring(0,e.length-2):o==6?e=e.substring(0,e.length-4):o==9?e=e.substring(0,e.length-5):e=e.substring(0,e.length-6),!e||this.xzqdm_down==e)return;this.xzqdm_up=null,this.xzqdm_down=e,this.parentXzqdm=e,c.Z.$emit("fit2region",{xzqdm:e,flag:l})}}else c.Z.$emit("fit2region",e)}imgHtml(t,l,i,e){let o=o=this.option.imageFontColor_1?this.option.imageFontColor_1:"#b95c10",r=this.option.bubbleNumTop?this.option.bubbleNumTop:32,a=this.getLightColor(o,.8);e===1&&(o=this.option.imageFontColor_2?this.option.imageFontColor_2:"#034f35",a=this.getLightColor(o,.8));let h="-1.2px 0 "+o+",0 1.2px "+o+",1.2px 0 "+o+",0 -1.2px "+o,n=this.option.fontSize?this.option.fontSize:18,u="<div>";return this.option.isShowNameTag&&(u+='<div class="bubbleText" style="position:absolute;width:100% ;text-align:center;top:'+((t-r)/2-10)+"px;left:"+(this.option.bubbleNumLeft?this.option.bubbleNumLeft:-3)+"px; font-size:12px; color: transparent;-webkit-text-fill-color: "+a+";text-shadow:"+h+';font-family: Microsoft YaHei;">'+l.name+":</div>"),u+='<div class="bubbleText" style="position:absolute;width:100% ;text-align:center;top:',this.option.isShowNameTag?u+=(t-r)/2+10:u+=(t-r)/2,u+="px;left:"+(this.option.bubbleNumLeft?this.option.bubbleNumLeft:-3)+"px; font-size:"+n+"px; color: transparent;-webkit-text-fill-color: "+a+";text-shadow:"+h+';font-family: Microsoft YaHei;">'+l.value+'</div><img class="bubbleImg" style="width:'+t+"px;height:"+t+'px;padding:1px;" src="'+i+'"/></div>',u}bubbleHtml(t,l,i,e,o){let r="rgb(255,255,253)",a=this.option.bubbleShadowColor_1?this.option.bubbleShadowColor_1:"rgba(170, 170, 170, 0.8)";e===1&&(a=this.option.bubbleShadowColor_2?this.option.bubbleShadowColor_2:"rgba(170, 170, 170, 0.8)");let h=this.getDarkColor(t,.6),n=this.getDarkColor(t,.5),u=this.option.fontSize?this.option.fontSize:"16",z="3px 6px 9px 0px";this.option.boxShadowSize&&(z=this.option.boxShadowSize-2+"px "+this.option.boxShadowSize+"px 7px 0px");let g='<div style="border-radius: 50%;border-style: solid;border-width: 1px;border-color: '+t+";background-image: -moz-linear-gradient( -50deg, "+r+" 0%,"+t+" 50%);background-image: -webkit-linear-gradient( -50deg, "+r+" 0%,"+t+" 50% );background-image: -ms-linear-gradient( -50deg, "+r+" 0%,"+t+" 50% );box-shadow:  "+z+" "+a+",inset 10px 15px 13px -10px rgba(255, 255, 255, 0.8),inset -8px -7px 13px -10px "+h+";position: relative;width: "+l+"px;height: "+l+'px;text-align: center;vertical-align: middle;display: table-cell;opacity: 0.9;">';return this.option.isShowNameTag&&(g+='<span class="nameTag" style="font-size:12px;-webkit-text-fill-color:'+this.getLightColor(t,.6)+"; text-shadow: -1px 0 "+n+", 0 1px "+n+", 1px 0 "+n+", 0 -1px "+n+';">'+o+":</span></br>"),g+='<span style="-webkit-text-fill-color:'+this.getLightColor(t,.6)+"; text-shadow: -1px 0 "+n+", 0 1px "+n+", 1px 0 "+n+", 0 -1px "+n+"; font-size: "+u+'px">'+i+"</span></div>",g}getDarkColor(t,l){let i=[];t.indexOf("#")!==-1?i=this.HexToRgb(t):t.indexOf("rgb")!==-1?i=t.split("(")[1].split(")")[0].split(","):t.indexOf(",")!==-1?i=t.split(","):i=t;for(let e=0;e<3;e++)i[e]=Math.floor(Number((i[e]+"").trim())*(1-l));return this.RgbToHex(i[0],i[1],i[2])}HexToRgb(t){t=t.replace("#","");let l=t.match(/../g);for(let i=0;i<3;i++)l[i]=parseInt(l[i],16);return l}RgbToHex(t,l,i){let e=[t.toString(16),l.toString(16),i.toString(16)];for(let o=0;o<3;o++)e[o].length==1&&(e[o]="0"+e[o]);return"#"+e.join("")}getLightColor(t,l){let i=[];t.indexOf("#")!==-1?i=this.HexToRgb(t):t.indexOf("rgb")!==-1?i=t.split("(")[1].split(")")[0].split(","):t.indexOf(",")!==-1?i=t.split(","):i=t;for(let e=0;e<3;e++)i[e]=Math.floor((255-Number((i[e]+"").trim()))*l+Number((i[e]+"").trim()));return this.RgbToHex(i[0],i[1],i[2])}addOnClickListener(t){this.onClickListener=t}}var X=U},55979:function(M,x){class s{constructor(){this.where,this.srsName,this.outputFormat="application/json",this.maxFeatures,this.startIndex,this.resultType}}x.Z=s},42447:function(M,x,s){var C=s(69787),c=s.n(C),S=s(53183),E=s.n(S);class L{constructor(m){this.layerOption=m}execute(m){let f={service:"wfs",version:"1.1.0",request:"GetFeature",typeName:this.layerOption.visibleLayers[0],outputFormat:m.outputFormat};return m.where&&(f.CQL_FILTER=m.where),m.srsName&&(f.srsName=m.srsName),m.startIndex&&(f.startIndex=m.startIndex),m.maxFeatures&&(f.maxFeatures=m.maxFeatures),m.resultType&&(f.resultType=m.resultType),new Promise((T,F)=>{let R=this.layerOption.identifyField[0].lyr+"/"+this.layerOption.visibleLayers[0].split(":")[0]+"/wfs";E().ajax({url:R,type:"POST",data:c().stringify(f),success:y=>{T(y)},error:y=>{F(y)}})})}}x.Z=L}}]);
